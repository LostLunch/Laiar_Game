<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실시간 채팅</title>
    <!-- Tailwind CSS CDN 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; }
        #chat-messages::-webkit-scrollbar { width: 8px; }
        #chat-messages::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #chat-messages::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        #chat-messages::-webkit-scrollbar-thumb:hover { background: #555; }
        #rolling-cat-container {
            position: fixed;
            bottom: 10px;
            left: 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            animation: rollAcross 20s linear infinite;
        }
        #cat-emoji { 
            font-size: 40px;
            /* [추가] 이미지로 부드럽게 전환되기 위해 크기 설정 */
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #cat-name {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-bottom: 5px;
            white-space: nowrap;
        }
        @keyframes rollAcross {
            0% { transform: translateX(-100px) rotate(0deg); }
            100% { transform: translateX(100vw) rotate(1800deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex items-center justify-center min-h-screen">
    <div class="w-full max-w-2xl mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 flex flex-col h-[80vh] max-h-[700px]">

            <!-- 방 선택 화면 -->
            <div id="room-selection" class="flex flex-col items-center justify-center h-full">
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">실시간 채팅</h1>
                <p class="text-gray-600 dark:text-gray-400 mb-8 text-center">친구와 대화를 시작해보세요.</p>
                <div class="w-full max-w-sm flex flex-col items-center gap-4">
                    <div class="w-full">
                        <label for="room-id-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 text-center">기존 방 참여하기</label>
                        <div class="flex gap-2">
                            <input id="room-id-input" type="text" placeholder="방 ID를 입력하세요" class="flex-1 p-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-center" disabled/>
                            <button id="join-existing-room-btn" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 disabled:bg-gray-400" disabled>참여</button>
                        </div>
                    </div>
                    <div class="my-2 flex items-center w-full"><hr class="w-full border-gray-300 dark:border-gray-600"><span class="px-4 text-gray-500">또는</span><hr class="w-full border-gray-300 dark:border-gray-600"></div>
                    <button id="create-new-room-btn" class="w-full px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 disabled:bg-gray-400" disabled>새로운 방 만들기</button>
                </div>
                 <p id="auth-status" class="mt-8 text-sm text-gray-500 dark:text-gray-400">인증 중...</p>
            </div>

            <!-- 대화 주제 선택 화면 -->
            <div id="topic-selection" class="hidden flex-col items-center justify-center h-full">
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">대화 주제가 결정되었습니다</h1>
                <div id="random-topic-display" class="mb-8 text-lg text-center text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 px-6 py-3 rounded-lg">
                    <!-- JavaScript에 의해 주제가 채워집니다 -->
                </div>
                <button id="start-chat-btn" class="w-full max-w-xs px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">시작하기</button>
            </div>

            <!-- 채팅방 화면 -->
            <div id="chat-room" class="hidden flex-1 flex-col min-h-0">
                <div class="mb-4">
                     <div class="flex justify-between items-center">
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">채팅방</h1>
                        <button id="leave-room-btn" class="text-sm text-red-500 hover:underline">나가기</button>
                     </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 break-all">방 ID: <span id="room-id-display" class="font-mono"></span></p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 break-all">내 ID: <span id="user-id-display" class="font-mono"></span></p>
                    <div id="participants-status" class="text-xs text-gray-500 dark:text-gray-400 mt-2 h-4"></div>
                </div>
                <div id="chat-messages" class="flex-1 overflow-y-auto bg-gray-50 dark:bg-gray-900 p-4 rounded-lg mb-4 border border-gray-200 dark:border-gray-700"></div>
                <form id="message-form" class="flex items-center gap-3">
                    <input id="message-input" type="text" placeholder="메시지를 입력하세요..." autocomplete="off" class="flex-1 p-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"/>
                    <button id="send-btn" type="submit" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">전송</button>
                </form>
            </div>
        </div>
    </div>
    
    <div id="rolling-cat-container">
        <div id="cat-name"></div>
        <div id="cat-emoji">🐈</div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, runTransaction, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDMgGwmlV9T8l0CPsMrJ8H0NrTTUNtSDMo",
            authDomain: "text-861c1.firebaseapp.com",
            projectId: "text-861c1",
            storageBucket: "text-861c1.firebasestorage.app",
            messagingSenderId: "521608830043",
            appId: "1:521608830043:web:5df3d118d76ca4562eb37e",
        };
        
        const roomSelection = document.getElementById('room-selection');
        const topicSelection = document.getElementById('topic-selection');
        const chatRoom = document.getElementById('chat-room');
        const roomIdInput = document.getElementById('room-id-input');
        const joinExistingRoomBtn = document.getElementById('join-existing-room-btn');
        const createNewRoomBtn = document.getElementById('create-new-room-btn');
        const leaveRoomBtn = document.getElementById('leave-room-btn');
        const roomIdDisplay = document.getElementById('room-id-display');
        const userIdDisplay = document.getElementById('user-id-display');
        const chatMessages = document.getElementById('chat-messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const authStatus = document.getElementById('auth-status');
        const participantsStatus = document.getElementById('participants-status');
        const randomTopicDisplay = document.getElementById('random-topic-display');
        const startChatBtn = document.getElementById('start-chat-btn');
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null, currentRoomId = null;
        let unsubscribeMessages = null, unsubscribeTurnStatus = null;
        let selectedTopic = null;
        
        function showNotification(message, type = 'error', duration = 3000) {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            notification.className = `fixed top-5 right-5 ${bgColor} text-white py-2 px-4 rounded-lg shadow-lg z-50`;
            notification.innerHTML = message;
            document.body.appendChild(notification);
            setTimeout(() => { notification.remove(); }, duration);
        }

        onAuthStateChanged(auth, user => {
            if (user) { 
                currentUser = user; 
                userIdDisplay.textContent = currentUser.uid.substring(0,8); 
                [roomIdInput, joinExistingRoomBtn, createNewRoomBtn].forEach(el => el.disabled = false);
                authStatus.textContent = '인증 완료'; 
                authStatus.classList.add('text-green-500');
            } else { 
                signInAnonymously(auth).catch(err => showNotification("익명 인증 실패: " + err.message));
            }
        });
        
        const lockUI = () => {
            messageInput.disabled = true;
            sendBtn.disabled = true;
            sendBtn.textContent = '대기 중...';
        };
        const unlockUI = () => {
            messageInput.disabled = false;
            sendBtn.disabled = false;
            sendBtn.textContent = '전송';
        };

        async function enterChatRoom(roomId) {
            currentRoomId = roomId; 
            roomIdDisplay.textContent = currentRoomId; 
            topicSelection.classList.add('hidden');
            roomSelection.classList.add('hidden'); 
            chatRoom.classList.remove('hidden'); 
            chatRoom.classList.add('flex');
            
            const turnStatusRef = doc(db, `chat_rooms/${roomId}/turn_status`, 'current');
            try {
                await updateDoc(turnStatusRef, { participants: arrayUnion(currentUser.uid) });
            } catch (error) {
                if (error.code === 'not-found') {
                    await setDoc(turnStatusRef, { participants: [currentUser.uid], submissions: {} });
                }
            }
            
            listenToTurnStatus(roomId);
            loadMessages(roomId); 
        }

        function showTopicSelectionScreen() {
            const topics = ["일상 대화", "영화 이야기", "음식 추천"];
            selectedTopic = topics[Math.floor(Math.random() * topics.length)];
            randomTopicDisplay.innerHTML = `주제: ${selectedTopic} <span class="text-red-500 font-bold ml-2">(라이어)</span>`;
            
            roomSelection.classList.add('hidden');
            topicSelection.classList.remove('hidden');
            topicSelection.classList.add('flex');
        }

        joinExistingRoomBtn.addEventListener('click', async () => {
            const roomId = roomIdInput.value.trim(); 
            if (!roomId) return showNotification("방 ID를 입력해주세요.");
            const docSnap = await getDoc(doc(db, 'chat_rooms', roomId));
            if (docSnap.exists()) {
                currentRoomId = roomId;
                showTopicSelectionScreen();
            } else { 
                showNotification("방을 찾을 수 없습니다.");
            }
        });

        createNewRoomBtn.addEventListener('click', async () => {
            const newRoomId = Math.random().toString(36).substring(2, 8);
            await setDoc(doc(db, 'chat_rooms', newRoomId), { createdAt: serverTimestamp() });
            currentRoomId = newRoomId;
            showTopicSelectionScreen();
        });
        
        startChatBtn.addEventListener('click', async () => {
            if (!selectedTopic || !currentRoomId) return;

            enterChatRoom(currentRoomId);
            const messagesColPath = `chat_rooms/${currentRoomId}/messages`;
            await addDoc(collection(db, messagesColPath), {
                text: `"${selectedTopic}" 주제로 대화를 시작합니다.`,
                senderId: 'system',
                timestamp: serverTimestamp()
            });
        });

        leaveRoomBtn.addEventListener('click', async () => {
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribeTurnStatus) unsubscribeTurnStatus();

            if (currentRoomId && currentUser) {
                const turnStatusRef = doc(db, `chat_rooms/${currentRoomId}/turn_status`, 'current');
                await updateDoc(turnStatusRef, { participants: arrayRemove(currentUser.uid) });
            }

            currentRoomId = null; 
            chatMessages.innerHTML = ''; 
            participantsStatus.textContent = '';
            chatRoom.classList.add('hidden'); 
            topicSelection.classList.add('hidden');
            roomSelection.classList.remove('hidden'); 
            unlockUI();
        });

        function loadMessages(roomId) {
            const q = query(collection(db, `chat_rooms/${roomId}/messages`));
            unsubscribeMessages = onSnapshot(q, snapshot => {
                let messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                messages.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                renderMessages(messages); 
            });
        }
        
        function listenToTurnStatus(roomId) {
            const turnStatusRef = doc(db, `chat_rooms/${roomId}/turn_status`, 'current');
            unsubscribeTurnStatus = onSnapshot(turnStatusRef, (docSnap) => {
                if (!docSnap.exists()) return;
                
                const turnData = docSnap.data();
                const submissions = turnData.submissions || {};
                const participants = turnData.participants || [];

                participantsStatus.textContent = `제출 현황: ${Object.keys(submissions).length} / ${participants.length}`;

                if (submissions[currentUser.uid]) {
                    lockUI();
                } else {
                    unlockUI();
                }
            });
        }
        
        function renderSingleBubble(msgData, isRound = false) {
             const isMe = msgData.senderId === currentUser.uid;
             const wrapper = document.createElement('div');
             wrapper.className = `flex ${isMe ? 'justify-end' : 'justify-start'} ${isRound ? 'my-1' : 'mb-3'}`;
             const container = document.createElement('div');
             if (!isMe) {
                 const senderName = document.createElement('p');
                 senderName.className = 'text-xs text-gray-500 dark:text-gray-400 mb-1 ml-3';
                 senderName.textContent = `User-${msgData.senderId.substring(0, 4)}`;
                 container.appendChild(senderName);
             }
             const bubble = document.createElement('div');
             let bubbleClasses = 'max-w-md lg:max-w-lg px-4 py-3 rounded-2xl ';
             bubble.className = bubbleClasses + (isMe ? 'bg-blue-600 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200');
             bubble.textContent = msgData.text;
             container.appendChild(bubble);
             wrapper.appendChild(container);
             return wrapper;
        }

        function renderMessages(messages) {
            chatMessages.innerHTML = ''; 
            messages.forEach(msg => {
                if (msg.senderId === 'system') {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'flex justify-center my-3';
                    const textDiv = document.createElement('div');
                    textDiv.className = 'text-xs text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 px-3 py-1 rounded-full';
                    textDiv.textContent = msg.text;
                    wrapper.appendChild(textDiv);
                    chatMessages.appendChild(wrapper);
                } else if (msg.type === 'round' && msg.roundData) {
                    const roundWrapper = document.createElement('div');
                    roundWrapper.className = 'border-l-2 border-gray-300 dark:border-gray-600 pl-3 my-4 py-2';
                    msg.roundData.forEach(roundMsg => {
                        roundWrapper.appendChild(renderSingleBubble(roundMsg, true));
                    });
                    chatMessages.appendChild(roundWrapper);
                } else {
                     chatMessages.appendChild(renderSingleBubble(msg));
                }
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault(); 
            const messageText = messageInput.value.trim(); 
            if (!messageText) return;
            lockUI();

            const turnStatusRef = doc(db, `chat_rooms/${currentRoomId}/turn_status`, 'current');

            try {
                let roundCompletedByThisAction = false;

                await runTransaction(db, async (transaction) => {
                    const turnDoc = await transaction.get(turnStatusRef);
                    if (!turnDoc.exists()) throw "Turn document does not exist.";

                    const turnData = turnDoc.data();
                    const submissions = turnData.submissions || {};
                    const participants = turnData.participants || [];

                    if (submissions[currentUser.uid]) return; 

                    const newSubmissions = { ...submissions, [currentUser.uid]: messageText };
                    const allSubmitted = participants.every(p => newSubmissions[p]);

                    if (allSubmitted && participants.length > 0) {
                        const roundMessages = participants.map(pId => ({ senderId: pId, text: newSubmissions[pId] }));
                        const newMsgRef = doc(collection(db, `chat_rooms/${currentRoomId}/messages`));
                        
                        transaction.set(newMsgRef, {
                            type: 'round',
                            roundData: roundMessages,
                            timestamp: serverTimestamp()
                        });
                        transaction.update(turnStatusRef, { submissions: {} });
                        
                        roundCompletedByThisAction = true;

                    } else {
                        transaction.update(turnStatusRef, { submissions: newSubmissions });
                    }
                });
                
                messageInput.value = '';

                if (roundCompletedByThisAction) {
                    unlockUI();
                }

            } catch (error) {
                console.error("메시지 제출 트랜잭션 오류: ", error);
                showNotification("메시지 제출에 실패했습니다.");
                unlockUI();
            }
        });
        
        // --- [수정] 확률적으로 고양이 모습 바꾸기 기능 ---
        const catEmojiElement = document.getElementById('cat-emoji');
        // [수정] 업로드된 이미지를 Base64 데이터 URL로 변환하여 변수에 저장합니다.
        const specialCatImageUrl = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAEnQAABJ0Ad5mH3gAAAUoSURBVHhe7VtdiFVVFL7v2+lu1VOzBjPMMsPSChIiiCBEsiiyoKIvCl0oF6GuhUIXgghZFgU9iIgiA9EDpdFFL0UXQW9EEARdKEPYDBKkZ5Znpudk+5x7Du/M2b177z1z9jrnwz8+955zfp9zZ87ce885gP+nEaE0IZQmBNmE0L1YhNCkI5QmBNmE0IZQm3BCaEKoTQhNCK3b9GkQghC+ZgihS0M0J9S2QmiD0DQhNCeEMgStEELrhNCG0Lq2CeH5IQQhNCeE2oRQE6E/QmhC+LgQmvB/DkL//xGhtCEAixAaFrRACG0IgRCaFkIQ+hAaF95fEIIQEIIQIX+FEKGEEEIIO/gqhBCChBAhhBDyP1aE0A9DCEKEEEKkEMJEiP5NCM2TUIQQqoS+b8I8CEEIdQn9N+F5IQQhtCW0bhuE0H8hhCB0CU3D8I4QhC7B9+UhhC6FaUIoTRBC6ED4g+A3QgghdOENJIT6NwhBuCF+EELvQmhDtA6aELoTWhOEc0LoIghBCH0LzRAaLwSBkBBChBCChBC6EKqEEELrRAjNCaENQTehH4TGE4QQ+lG4Bf1iA6GEEHpHCKE9IdQhdCdUCCE0ZwhdaDwhdBe0TQj9IBQhhBC6EKoTQm1CuAl9ILwEIdQndC8mEEIIpQmhJkL3YhdC/1+BEEI3Qm1CeCGEEEIIofcMhNCb0A+hG0JnQmk6aEIIIYReL0I/hDaE2oReEMpGCCA0TQjVCH0f6kJ4hRBC6AWhG4TGEyGEEMITQoh+IYSwhhBCEELvWwh9CM0QRQjVCOEN4ReFEILQnaAThDaEegidCSGEEGoThNC88B6E0AQhBCGEGkJoTohGhNCGkJkQ+iHEaRBCv8bK0P+9CEEIMYQQQohQQghBCH3/4J8IoQuhH0LrhNAsEKGEEELrE0JoQ/gjhC6FNoReEJoQ+kEIIYReEELoTaggdCe0RgghhDaE7oTwhRBC6EIIIfQnhNCG0BWhYUKoQwhB6EKIGkJrQmhDtA6EEEJnQj9Ebwj9EIQQQmhC6ET4x34BfLwQeucn9L+JEEKIGkIIIYQQQk2EEMITwvc/CCHk4EEIIYRehRBC6EH4d3whhLCE/jfw6EEIIYQQwveL/QQIoQkhQghBuCFCCCEIIYQQQgiBWBBCEIIQPnwhhJATQk2EEELrRAghhNCb0JoQmhBCEMIIpQmhCYFGEEIIQeghhLCEEGIIQQhdCP+fA0JrhRBCCH0Q/l8LhBCaEIIIIdQhdCM0Rwh9CF0JpQmBH0IIIfSjUIII/RehCaEThRBCaED4/x4IoQkhQgi1CaEToR/Ck4MQghBCaEJ4Twh9EMIQohOEEEIIQeha4D/WEIIIIdQhNCE0QwiNEULoTPhPGEIIofVCCCE0QxAhdCG0RgghhNAtEIII/QmhCaE74XlCCEEKIdQgNB+EEEJvhNCG0IXwdwgCofWCEEII3QnhF4TGE4RGEEI3QgghVCN8DUIoTRBCaEIQ2oEQQohQjRBCaIboRCghdCM8ryGEEEIpoUmhCaFNoQnB/RBC6EH4o1BCaEIIIbQmNCE0TQj9EIIQWhNCGUL7hRBCaEIIoRWhjRBCX4ReEIQQmtA/IYTGE0JnQm1CCEGIIAThhNCG0BoRQsOAECGE0AQhBKEToV+hDSEToXWhfSEMIUSNEEIIrReaEHpBCKE7oR8aBCH0o7+EECGEEIQQohGEEEIIpQkCEEIITQihCaEVQm1CaEDoG5/vX/30V5qgAAAAAElFTkSuQmCC";
        let isSpecialCatVisible = false; // 특별한 고양이가 보이는 중인지 추적하는 변수

        // [추가] 타이핑 시 0.1% 확률로 고양이 모습 바꾸기
        messageInput.addEventListener('input', () => {
            // 0.1% 확률(0.001)이고, 특별한 고양이가 아직 안보일 때
            if (Math.random() < 0.001 && !isSpecialCatVisible) {
                isSpecialCatVisible = true;
                
                // 특별한 고양이 이미지로 변경
                catEmojiElement.innerHTML = `<img src="${specialCatImageUrl}" alt="special cat" class="w-12 h-12">`;

                // 5초 후에 다시 원래 이모지로 되돌림
                setTimeout(() => {
                    catEmojiElement.innerHTML = '🐈';
                    isSpecialCatVisible = false;
                }, 5000); // 5초
            }
        });

        const catNameElement = document.getElementById('cat-name');
        const names = ["이*혁", "고*건", "송*훈", "최*준", "한*상", "박*원", "이*수", "이*영", "트라라라라라라"];
        const randomName = names[Math.floor(Math.random() * names.length)];
        catNameElement.textContent = randomName;
        
    </script>
</body>
</html>