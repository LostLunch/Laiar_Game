<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ì±„íŒ…</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; }
        #chat-messages::-webkit-scrollbar { width: 8px; }
        #chat-messages::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #chat-messages::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        #chat-messages::-webkit-scrollbar-thumb:hover { background: #555; }
        #rolling-cat-container {
            position: fixed;
            bottom: 10px;
            left: 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            animation: rollAcross 20s linear infinite;
        }
        #cat-emoji { 
            font-size: 40px;
            /* [ì¶”ê°€] ì´ë¯¸ì§€ë¡œ ë¶€ë“œëŸ½ê²Œ ì „í™˜ë˜ê¸° ìœ„í•´ í¬ê¸° ì„¤ì • */
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #cat-name {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-bottom: 5px;
            white-space: nowrap;
        }
        @keyframes rollAcross {
            0% { transform: translateX(-100px) rotate(0deg); }
            100% { transform: translateX(100vw) rotate(1800deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex items-center justify-center min-h-screen">
    <div class="w-full max-w-2xl mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 flex flex-col h-[80vh] max-h-[700px]">

            <!-- ë°© ì„ íƒ í™”ë©´ -->
            <div id="room-selection" class="flex flex-col items-center justify-center h-full">
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">ì‹¤ì‹œê°„ ì±„íŒ…</h1>
                <p class="text-gray-600 dark:text-gray-400 mb-8 text-center">ì¹œêµ¬ì™€ ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”.</p>
                <div class="w-full max-w-sm flex flex-col items-center gap-4">
                    <div class="w-full">
                        <label for="room-id-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 text-center">ê¸°ì¡´ ë°© ì°¸ì—¬í•˜ê¸°</label>
                        <div class="flex gap-2">
                            <input id="room-id-input" type="text" placeholder="ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”" class="flex-1 p-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-center" disabled/>
                            <button id="join-existing-room-btn" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 disabled:bg-gray-400" disabled>ì°¸ì—¬</button>
                        </div>
                    </div>
                    <div class="my-2 flex items-center w-full"><hr class="w-full border-gray-300 dark:border-gray-600"><span class="px-4 text-gray-500">ë˜ëŠ”</span><hr class="w-full border-gray-300 dark:border-gray-600"></div>
                    <button id="create-new-room-btn" class="w-full px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 disabled:bg-gray-400" disabled>ìƒˆë¡œìš´ ë°© ë§Œë“¤ê¸°</button>
                </div>
                 <p id="auth-status" class="mt-8 text-sm text-gray-500 dark:text-gray-400">ì¸ì¦ ì¤‘...</p>
            </div>


            <!-- ì±„íŒ…ë°© í™”ë©´ -->
            <div id="chat-room" class="hidden flex-1 flex-col min-h-0">
                <div class="mb-4">
                     <div class="flex justify-between items-center">
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">ì‚¬ëŒ ì°¾ê¸° ê²Œì„</h1>
                        <button id="leave-room-btn" class="text-sm text-red-500 hover:underline">ë‚˜ê°€ê¸°</button>
                     </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 break-all">ë°© ID: <span id="room-id-display" class="font-mono"></span></p>
                    <div id="role-display" class="text-sm font-semibold mt-2"></div>
                    <div id="game-word-display" class="hidden mb-3 p-3 bg-yellow-100 dark:bg-yellow-900 border border-yellow-300 dark:border-yellow-600 rounded-lg">
                        <div class="text-sm font-semibold text-yellow-800 dark:text-yellow-200 mb-1">ì œì‹œì–´</div>
                        <div id="current-word" class="text-lg font-bold text-yellow-900 dark:text-yellow-100"></div>
                    </div>
                    <div id="game-status" class="text-sm text-gray-600 dark:text-gray-400 mt-2">
                        5ëª…ì˜ ìš©ì˜ì ì¤‘ 1ëª…ì€ ì§„ì§œ ì‚¬ëŒì…ë‹ˆë‹¤. ëˆ„ê°€ ì§„ì§œ ì‚¬ëŒì¸ì§€ ì°¾ì•„ë³´ì„¸ìš”!
                    </div>
                    <div id="participants-info" class="text-xs text-gray-500 dark:text-gray-400 mt-2"></div>
                </div>
                <div id="chat-messages" class="flex-1 overflow-y-auto bg-gray-50 dark:bg-gray-900 p-4 rounded-lg mb-4 border border-gray-200 dark:border-gray-700"></div>
                <div id="operator-input" class="hidden mb-3">
                    <form id="operator-form" class="flex items-center gap-3">
                        <input id="operator-message-input" type="text" placeholder="ìš´ì˜ìë¡œì„œ ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" class="flex-1 p-3 bg-yellow-50 dark:bg-yellow-900 border border-yellow-300 dark:border-yellow-600 rounded-lg"/>
                        <button id="operator-send-btn" type="submit" class="px-6 py-3 bg-yellow-600 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-700">ì „ì†¡</button>
                    </form>
                </div>
                <form id="message-form" class="flex items-center gap-3">
                    <input id="message-input" type="text" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" class="flex-1 p-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"/>
                    <button id="send-btn" type="submit" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">ì§ˆë¬¸</button>
                </form>
            </div>
        </div>
    </div>
    
    <div id="rolling-cat-container">
        <div id="cat-name"></div>
        <div id="cat-emoji">ğŸˆ</div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, runTransaction, writeBatch, orderBy, limit, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDMgGwmlV9T8l0CPsMrJ8H0NrTTUNtSDMo",
            authDomain: "text-861c1.firebaseapp.com",
            projectId: "text-861c1",
            storageBucket: "text-861c1.firebasestorage.app",
            messagingSenderId: "521608830043",
            appId: "1:521608830043:web:5df3d118d76ca4562eb37e",
        };
        
        const roomSelection = document.getElementById('room-selection');
        const chatRoom = document.getElementById('chat-room');
        const roomIdInput = document.getElementById('room-id-input');
        const joinExistingRoomBtn = document.getElementById('join-existing-room-btn');
        const createNewRoomBtn = document.getElementById('create-new-room-btn');
        const leaveRoomBtn = document.getElementById('leave-room-btn');
        const roomIdDisplay = document.getElementById('room-id-display');
        const chatMessages = document.getElementById('chat-messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const authStatus = document.getElementById('auth-status');
        const gameStatus = document.getElementById('game-status');
        const roleDisplay = document.getElementById('role-display');
        const participantsInfo = document.getElementById('participants-info');
        const operatorInput = document.getElementById('operator-input');
        const operatorForm = document.getElementById('operator-form');
        const operatorMessageInput = document.getElementById('operator-message-input');
        const operatorSendBtn = document.getElementById('operator-send-btn');
        const gameWordDisplay = document.getElementById('game-word-display');
        const currentWord = document.getElementById('current-word');
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null, currentRoomId = null;
        let unsubscribeMessages = null;
        let currentGameWord = null;
        let gamePhase = 'statement1';
        let isOperator = false; // ë°© ìƒì„±ìì¸ì§€ ì—¬ë¶€
        let isGameStarted = false;
        let suspectNames = []; // ìš©ì˜ì ì´ë¦„ ë°°ì—´
        let operatorSuspectIndex = -1; // ìš´ì˜ìê°€ ëª‡ ë²ˆ ìš©ì˜ìì¸ì§€
        let waitingForOperatorResponse = false;
        
        function showNotification(message, type = 'error', duration = 3000) {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            notification.className = `fixed top-5 right-5 ${bgColor} text-white py-2 px-4 rounded-lg shadow-lg z-50`;
            notification.innerHTML = message;
            document.body.appendChild(notification);
            setTimeout(() => { notification.remove(); }, duration);
        }

        onAuthStateChanged(auth, user => {
            if (user) { 
                currentUser = user; 
                [roomIdInput, joinExistingRoomBtn, createNewRoomBtn].forEach(el => el.disabled = false);
                authStatus.textContent = 'ì¸ì¦ ì™„ë£¼'; 
                authStatus.classList.add('text-green-500');
                console.log('ì¸ì¦ ì™„ë£Œ, ë²„íŠ¼ í™œì„±í™” ì™„ë£Œ');
            } else { 
                signInAnonymously(auth).catch(err => showNotification("ìµëª… ì¸ì¦ ì‹¤íŒ¨: " + err.message));
            }
        });
        

        function generateSuspectNames() {
            // ìš©ì˜ì ì´ë¦„ì„ ëœë¤ìœ¼ë¡œ ì„¬ê¸°
            suspectNames = ['ìš©ì˜ì 1', 'ìš©ì˜ì 2', 'ìš©ì˜ì 3', 'ìš©ì˜ì 4', 'ìš©ì˜ì 5'];
            // ë°°ì—´ì„ ëœë¤ìœ¼ë¡œ ì„¬ê¸°
            for (let i = suspectNames.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [suspectNames[i], suspectNames[j]] = [suspectNames[j], suspectNames[i]];
            }
            // ìš´ì˜ìê°€ ëª‡ ë²ˆ ìš©ì˜ìì¸ì§€ ì €ì¥ (0~4 ì¸ë±ìŠ¤)
            operatorSuspectIndex = Math.floor(Math.random() * 5);
        }

        async function enterChatRoom(roomId, asOperator = false) {
            currentRoomId = roomId; 
            isOperator = asOperator;
            roomIdDisplay.textContent = currentRoomId; 
            roomSelection.classList.add('hidden'); 
            chatRoom.classList.remove('hidden'); 
            chatRoom.classList.add('flex');
            
            // ìš©ì˜ì ì´ë¦„ ìƒì„±
            generateSuspectNames();
            
            // ì—­í•  í‘œì‹œ
            if (isOperator) {
                roleDisplay.textContent = 'ë‹¹ì‹ ì€ ìš´ì˜ìì…ë‹ˆë‹¤';
                roleDisplay.className = 'text-sm font-semibold mt-2 text-yellow-600 dark:text-yellow-400';
                operatorInput.classList.remove('hidden');
                participantsInfo.textContent = 'ì‚¬ìš©ìê°€ ì…ì¥í•˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...';
            } else {
                roleDisplay.textContent = 'ë‹¹ì‹ ì€ ì²´í—˜ìì…ë‹ˆë‹¤';
                roleDisplay.className = 'text-sm font-semibold mt-2 text-blue-600 dark:text-blue-400';
                participantsInfo.textContent = `ìš´ì˜ìëŠ” ${suspectNames[operatorSuspectIndex]}ì…ë‹ˆë‹¤. (ë¹„ë°€)`;
            }
            
            // ê²Œì„ ì‹œì‘ ë©”ì‹œì§€ ì¶”ê°€ ë° ì œì‹œì–´ ì„¤ì •
            if (asOperator) {
                // ì œì‹œì–´ ê°€ì ¸ì˜¤ê¸°
                try {
                    const wordResult = await callLiarGameAPI('/api/start_dec');
                    if (wordResult && wordResult.word) {
                        currentGameWord = wordResult.word;
                        currentWord.textContent = currentGameWord;
                        gameWordDisplay.classList.remove('hidden');
                        
                        // ë°©ì— ì œì‹œì–´ ì €ì¥
                        await updateDoc(doc(db, 'chat_rooms', roomId), {
                            currentWord: currentGameWord
                        });
                        
                        await addDoc(collection(db, `chat_rooms/${roomId}/messages`), {
                            text: `ì‚¬ëŒ ì°¾ê¸° ê²Œì„ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! ì œì‹œì–´ëŠ” "${currentGameWord}"ì…ë‹ˆë‹¤. 5ëª…ì˜ ìš©ì˜ì ì¤‘ 1ëª…ì€ ì§„ì§œ ì‚¬ëŒì…ë‹ˆë‹¤.`,
                            senderId: 'system',
                            timestamp: serverTimestamp()
                        });
                    } else {
                        await addDoc(collection(db, `chat_rooms/${roomId}/messages`), {
                            text: 'ì‚¬ëŒ ì°¾ê¸° ê²Œì„ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! 5ëª…ì˜ ìš©ì˜ì ì¤‘ 1ëª…ì€ ì§„ì§œ ì‚¬ëŒì…ë‹ˆë‹¤.',
                            senderId: 'system',
                            timestamp: serverTimestamp()
                        });
                    }
                } catch (error) {
                    console.error('ì œì‹œì–´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                    await addDoc(collection(db, `chat_rooms/${roomId}/messages`), {
                        text: 'ì‚¬ëŒ ì°¾ê¸° ê²Œì„ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! 5ëª…ì˜ ìš©ì˜ì ì¤‘ 1ëª…ì€ ì§„ì§œ ì‚¬ëŒì…ë‹ˆë‹¤.',
                        senderId: 'system',
                        timestamp: serverTimestamp()
                    });
                }
            } else {
                // ì°¸ê°€ìë„ ì œì‹œì–´ í‘œì‹œ
                // ë°©ì— ì €ì¥ëœ ì œì‹œì–´ ê°€ì ¸ì˜¤ê¸° ì‹œë„
                const roomDoc = await getDoc(doc(db, 'chat_rooms', roomId));
                if (roomDoc.exists() && roomDoc.data().currentWord) {
                    currentGameWord = roomDoc.data().currentWord;
                    currentWord.textContent = currentGameWord;
                    gameWordDisplay.classList.remove('hidden');
                }
            }
            
            loadMessages(roomId); 
        }


        joinExistingRoomBtn.addEventListener('click', async () => {
            const roomId = roomIdInput.value.trim(); 
            if (!roomId) return showNotification("ë°© IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            const docSnap = await getDoc(doc(db, 'chat_rooms', roomId));
            if (docSnap.exists()) {
                // ì°¸ê°€ìë¡œ ì…ì¥ (ì²´í—˜ì)
                enterChatRoom(roomId, false);
            } else { 
                showNotification("ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        });

        createNewRoomBtn.addEventListener('click', async () => {
            const newRoomId = Math.random().toString(36).substring(2, 8);
            await setDoc(doc(db, 'chat_rooms', newRoomId), { 
                createdAt: serverTimestamp(),
                operatorId: currentUser.uid,
                currentWord: null // ì œì‹œì–´ëŠ” ë‚˜ì¤‘ì— ì„¤ì •
            });
            // ìš´ì˜ìë¡œ ì…ì¥
            enterChatRoom(newRoomId, true);
        });
        
        // API í˜¸ì¶œ í•¨ìˆ˜
        async function callLiarGameAPI(endpoint, data = {}) {
            try {
                console.log(`API í˜¸ì¶œ ì‹œë„: ${endpoint}`, data);
                const response = await fetch(`http://127.0.0.1:5000${endpoint}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                console.log('API ì‘ë‹µ ìƒíƒœ:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('API ì‘ë‹µ ë°ì´í„°:', result);
                return result;
            } catch (error) {
                console.error('API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                showNotification(`API í˜¸ì¶œ ì˜¤ë¥˜: ${error.message}. ë°±ì—”ë“œ ì„œë²„(http://127.0.0.1:5000)ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.`);
                return null;
            }
        }
        
        async function processGameTurn(userQuestion) {
            try {
                if (!isGameStarted) {
                    // ì²˜ìŒ ê²Œì„ ì‹œì‘
                    isGameStarted = true;
                    await addDoc(collection(db, `chat_rooms/${currentRoomId}/messages`), {
                        text: 'ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! ìš´ì˜ìì˜ ë‹µë³€ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...',
                        senderId: 'system',
                        timestamp: serverTimestamp()
                    });
                }
                
                // ìš´ì˜ìì—ê²Œ ë‹µë³€ ìš”ì²­
                if (isOperator) {
                    // ìš´ì˜ìëŠ” ë‹µë³€ ì…ë ¥ ì°½ í™œì„±í™”
                    waitingForOperatorResponse = true;
                    operatorMessageInput.placeholder = `"ìš©ì˜ì ${operatorSuspectIndex + 1}"ë¡œì„œ ë‹µë³€í•˜ì„¸ìš”: ${userQuestion}`;
                    showNotification('ìš´ì˜ìë¡œì„œ ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'info');
                } else {
                    // ì²´í—˜ìëŠ” ìš´ì˜ì ë‹µë³€ì„ ê¸°ë‹¤ë¦¼
                    showNotification('ìš´ì˜ìì˜ ë‹µë³€ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...', 'info');
                }
                
                // AI ì‘ë‹µ ìƒì„±
                let result;
                let phaseTitle;
                
                if (gamePhase === 'statement1' || gamePhase === 'statement2') {
                    result = await callLiarGameAPI('/api/start_dec');
                    phaseTitle = gamePhase === 'statement1' ? '1ì°¨ ì§„ìˆ  ë‹¨ê³„' : '2ì°¨ ì§„ìˆ  ë‹¨ê³„';
                    if (result) {
                        currentGameWord = result.word;
                        gamePhase = gamePhase === 'statement1' ? 'discussion1' : 'discussion2';
                    }
                } else if (gamePhase === 'discussion1' || gamePhase === 'discussion2') {
                    result = await callLiarGameAPI('/api/start_disc', { word: currentGameWord });
                    phaseTitle = gamePhase === 'discussion1' ? '1ì°¨ í† ë¡  ë‹¨ê³„' : '2ì°¨ í† ë¡  ë‹¨ê³„';
                    if (result) {
                        if (gamePhase === 'discussion1') {
                            gamePhase = 'statement2';
                        } else {
                            gamePhase = 'vote';
                        }
                    }
                }
                
                // ìš´ì˜ì ë‹µë³€ì„ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  AI ì‘ë‹µë§Œ ë¨¼ì € ì €ì¥
                if (result) {
                    const aiResponses = result.declaration_messages || result.discussion_messages;
                    
                    // AI ì‘ë‹µë“¤ì„ ìš©ì˜ì ì¸ë±ìŠ¤ì™€ ë§¤í•‘
                    const responses = [];
                    
                    // AI 4ëª…ì˜ ì‘ë‹µ ì¶”ê°€ (ìš´ì˜ì ì¸ë±ìŠ¤ ì œì™¸)
                    let aiIndex = 0;
                    for (let i = 0; i < 5; i++) {
                        if (i === operatorSuspectIndex) {
                            // ìš´ì˜ì ìë¦¬ëŠ” ë¹„ì›Œë‘ê³  ë‚˜ì¤‘ì— ì¶”ê°€
                            responses.push({ 
                                text: 'ë‹µë³€ ëŒ€ê¸° ì¤‘...', 
                                isOperator: true, 
                                suspectIndex: i 
                            });
                        } else {
                            responses.push({ 
                                text: aiResponses[aiIndex], 
                                isOperator: false, 
                                suspectIndex: i 
                            });
                            aiIndex++;
                        }
                    }
                    
                    // ì„ì‹œ ì €ì¥ (ìš´ì˜ì ë‹µë³€ ëŒ€ê¸° ì¤‘)
                    await addDoc(collection(db, `chat_rooms/${currentRoomId}/temp_responses`), {
                        responses: responses,
                        phaseTitle: phaseTitle,
                        questionId: Date.now(), // ì§ˆë¬¸ ID
                        timestamp: serverTimestamp()
                    });
                }
                
            } catch (error) {
                console.error('ê²Œì„ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                await addDoc(collection(db, `chat_rooms/${currentRoomId}/messages`), {
                    text: `ê²Œì„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`,
                    senderId: 'system',
                    timestamp: serverTimestamp()
                });
            }
        }

        leaveRoomBtn.addEventListener('click', async () => {
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribeTurnStatus) unsubscribeTurnStatus();

            if (currentRoomId && currentUser) {
                const turnStatusRef = doc(db, `chat_rooms/${currentRoomId}/turn_status`, 'current');
                await updateDoc(turnStatusRef, { participants: arrayRemove(currentUser.uid) });
            }

            currentRoomId = null; 
            chatMessages.innerHTML = ''; 
            chatRoom.classList.add('hidden'); 
            roomSelection.classList.remove('hidden'); 
            messageInput.disabled = false;
            sendBtn.disabled = false;
            sendBtn.textContent = 'ì „ì†¡';
            gamePhase = 'statement1';
            gameRound = 1;
            isGameStarted = false;
        });

        function loadMessages(roomId) {
            const q = query(collection(db, `chat_rooms/${roomId}/messages`));
            unsubscribeMessages = onSnapshot(q, snapshot => {
                let messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                messages.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                renderMessages(messages); 
            });
        }
        
        function updateGameStatus() {
            const phaseNames = {
                'statement1': '1ì°¨ ì§„ìˆ ',
                'discussion1': '1ì°¨ í† ë¡ ', 
                'statement2': '2ì°¨ ì§„ìˆ ',
                'discussion2': '2ì°¨ í† ë¡ ',
                'vote': 'íˆ¬í‘œ'
            };
            
            if (!isGameStarted) {
                gameStatus.textContent = 'ê²Œì„ì´ ê³§ ì‹œì‘ë©ë‹ˆë‹¤. ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ë©´ AIë“¤ê³¼ í•¨ê»˜ ë¼ì´ì–´ ê²Œì„ì´ ì‹œì‘ë©ë‹ˆë‹¤!';
            } else {
                gameStatus.textContent = `í˜„ì¬ ë‹¨ê³„: ${phaseNames[gamePhase] || gamePhase} | ì œì‹œì–´: ${currentGameWord || 'ëŒ€ê¸° ì¤‘'}`;
            }
        }
        
        
        function renderSingleBubble(msgData, suspectIndex = -1) {
             const isMe = msgData.senderId === currentUser.uid;
             const isOperatorMessage = msgData.senderId === 'operator';
             const wrapper = document.createElement('div');
             wrapper.className = `flex ${isMe ? 'justify-end' : 'justify-start'} mb-3`;
             const container = document.createElement('div');
             
             // ì´ë¦„ í‘œì‹œ
             if (!isMe && msgData.senderId !== 'system') {
                 const senderName = document.createElement('p');
                 senderName.className = 'text-xs text-gray-500 dark:text-gray-400 mb-1 ml-3';
                 
                 if (isOperatorMessage && suspectIndex >= 0) {
                     // ìš´ì˜ì ë©”ì‹œì§€ë¥¼ ìš©ì˜ì ì´ë¦„ìœ¼ë¡œ í‘œì‹œ
                     senderName.textContent = suspectNames[suspectIndex] || `ìš©ì˜ì ${suspectIndex + 1}`;
                 } else if (suspectIndex >= 0) {
                     // AI ë©”ì‹œì§€ë¥¼ ìš©ì˜ì ì´ë¦„ìœ¼ë¡œ í‘œì‹œ
                     senderName.textContent = suspectNames[suspectIndex] || `ìš©ì˜ì ${suspectIndex + 1}`;
                 } else {
                     senderName.textContent = `ì‚¬ìš©ì`;
                 }
                 container.appendChild(senderName);
             }
             
             const bubble = document.createElement('div');
             let bubbleClasses = 'max-w-md lg:max-w-lg px-4 py-3 rounded-2xl ';
             
             if (isMe) {
                 bubble.className = bubbleClasses + 'bg-blue-600 text-white';
             } else if (isOperatorMessage || suspectIndex >= 0) {
                 // ìš©ì˜ìë“¤ (ìš´ì˜ì + AI)
                 bubble.className = bubbleClasses + 'bg-purple-100 dark:bg-purple-800 text-purple-800 dark:text-purple-200 border border-purple-300 dark:border-purple-600';
             } else {
                 bubble.className = bubbleClasses + 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200';
             }
             
             bubble.textContent = msgData.text;
             container.appendChild(bubble);
             wrapper.appendChild(container);
             return wrapper;
        }

        function renderMessages(messages) {
            chatMessages.innerHTML = ''; 
            messages.forEach(msg => {
                if (msg.senderId === 'system') {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'flex justify-center my-3';
                    const textDiv = document.createElement('div');
                    textDiv.className = 'text-xs text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 px-3 py-1 rounded-full';
                    textDiv.textContent = msg.text;
                    wrapper.appendChild(textDiv);
                    chatMessages.appendChild(wrapper);
                } else if (msg.type === 'all_responses' && msg.responses) {
                    // ëª¨ë“  ì‘ë‹µë“¤ì„ ê·¸ë£¹ìœ¼ë¡œ í‘œì‹œ
                    const roundWrapper = document.createElement('div');
                    roundWrapper.className = 'border-l-4 border-purple-400 pl-4 my-4 py-2 bg-purple-50 dark:bg-purple-900 rounded-r-lg';
                    
                    const phaseTitle = document.createElement('div');
                    phaseTitle.className = 'text-sm font-semibold text-purple-700 dark:text-purple-300 mb-2';
                    phaseTitle.textContent = msg.phaseTitle || 'ìš©ì˜ìë“¤ì˜ ë‹µë³€';
                    roundWrapper.appendChild(phaseTitle);
                    
                    msg.responses.forEach((response, index) => {
                        const responseMsg = { 
                            text: response.text, 
                            senderId: response.isOperator ? 'operator' : 'ai'
                        };
                        roundWrapper.appendChild(renderSingleBubble(responseMsg, response.suspectIndex));
                    });
                    chatMessages.appendChild(roundWrapper);
                } else {
                     chatMessages.appendChild(renderSingleBubble(msg));
                }
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
            updateGameStatus();
        }
        
        // ì‚¬ìš©ì ì§ˆë¬¸ ì „ì†¡
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault(); 
            const messageText = messageInput.value.trim(); 
            if (!messageText) return;
            
            // ìš´ì˜ìëŠ” ì§ˆë¬¸ì„ í•  ìˆ˜ ì—†ìŒ
            if (isOperator) {
                showNotification('ìš´ì˜ìëŠ” ì§ˆë¬¸ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // UI ì ê¸ˆ
            messageInput.disabled = true;
            sendBtn.disabled = true;
            sendBtn.textContent = 'ì²˜ë¦¬ ì¤‘...';
            
            try {
                console.log('ì‚¬ìš©ì ì§ˆë¬¸ ì „ì†¡:', messageText);
                
                // ì‚¬ìš©ì ì§ˆë¬¸ ì¶”ê°€
                await addDoc(collection(db, `chat_rooms/${currentRoomId}/messages`), {
                    text: messageText,
                    senderId: currentUser.uid,
                    timestamp: serverTimestamp()
                });
                
                messageInput.value = '';
                console.log('ì‚¬ìš©ì ì§ˆë¬¸ ì €ì¥ ì™„ë£Œ');
                
                // ê²Œì„ í„´ ì²˜ë¦¬
                console.log('ê²Œì„ í„´ ì²˜ë¦¬ ì‹œì‘...');
                await processGameTurn(messageText);
                console.log('ê²Œì„ í„´ ì²˜ë¦¬ ì™„ë£Œ');
                
            } catch (error) {
                console.error("ì§ˆë¬¸ ì „ì†¡ ì˜¤ë¥˜: ", error);
                showNotification("ì§ˆë¬¸ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            } finally {
                // UI ì ê¸ˆ í•´ì œ
                messageInput.disabled = false;
                sendBtn.disabled = false;
                sendBtn.textContent = 'ì§ˆë¬¸';
                console.log('UI ì ê¸ˆ í•´ì œ ì™„ë£Œ');
            }
        });
        
        // ìš´ì˜ì ë‹µë³€ ì „ì†¡
        operatorForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const responseText = operatorMessageInput.value.trim();
            if (!responseText || !waitingForOperatorResponse) return;
            
            operatorMessageInput.disabled = true;
            operatorSendBtn.disabled = true;
            operatorSendBtn.textContent = 'ì „ì†¡ ì¤‘...';
            
            try {
                // ìµœì‹  temp_responses ì°¾ê¸°
                const tempQuery = query(
                    collection(db, `chat_rooms/${currentRoomId}/temp_responses`),
                    orderBy('timestamp', 'desc'),
                    limit(1)
                );
                const tempSnapshot = await getDocs(tempQuery);
                
                if (!tempSnapshot.empty) {
                    const tempDoc = tempSnapshot.docs[0];
                    const tempData = tempDoc.data();
                    
                    // ìš´ì˜ì ë‹µë³€ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                    const updatedResponses = tempData.responses.map(response => {
                        if (response.isOperator && response.suspectIndex === operatorSuspectIndex) {
                            return { ...response, text: responseText };
                        }
                        return response;
                    });
                    
                    // ìµœì¢… ì‘ë‹µ ì €ì¥
                    await addDoc(collection(db, `chat_rooms/${currentRoomId}/messages`), {
                        type: 'all_responses',
                        responses: updatedResponses,
                        phaseTitle: tempData.phaseTitle,
                        timestamp: serverTimestamp()
                    });
                    
                    // ì„ì‹œ ë°ì´í„° ì‚­ì œ
                    await deleteDoc(tempDoc.ref);
                    
                    waitingForOperatorResponse = false;
                    operatorMessageInput.value = '';
                    operatorMessageInput.placeholder = 'ìš´ì˜ìë¡œì„œ ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”...';
                }
                
            } catch (error) {
                console.error('ìš´ì˜ì ë‹µë³€ ì „ì†¡ ì˜¤ë¥˜:', error);
                showNotification('ë‹µë³€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                operatorMessageInput.disabled = false;
                operatorSendBtn.disabled = false;
                operatorSendBtn.textContent = 'ì „ì†¡';
            }
        });
        
        // --- [ìˆ˜ì •] í™•ë¥ ì ìœ¼ë¡œ ê³ ì–‘ì´ ëª¨ìŠµ ë°”ê¾¸ê¸° ê¸°ëŠ¥ ---
        const catEmojiElement = document.getElementById('cat-emoji');
        // [ìˆ˜ì •] ì—…ë¡œë“œëœ ì´ë¯¸ì§€ë¥¼ Base64 ë°ì´í„° URLë¡œ ë³€í™˜í•˜ì—¬ ë³€ìˆ˜ì— ì €ì¥í•©ë‹ˆë‹¤.
        const specialCatImageUrl = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAEnQAABJ0Ad5mH3gAAAUoSURBVHhe7VtdiFVVFL7v2+lu1VOzBjPMMsPSChIiiCBEsiiyoKIvCl0oF6GuhUIXgghZFgU9iIgiA9EDpdFFL0UXQW9EEARdKEPYDBKkZ5Znpudk+5x7Du/M2b177z1z9jrnwz8+955zfp9zZ87ce885gP+nEaE0IZQmBNmE0L1YhNCkI5QmBNmE0IZQm3BCaEKoTQhNCK3b9GkQghC+ZgihS0M0J9S2QmiD0DQhNCeEMgStEELrhNCG0Lq2CeH5IQQhNCeE2oRQE6E/QmhC+LgQmvB/DkL//xGhtCEAixAaFrRACG0IgRCaFkIQ+hAaF95fEIIQEIIQIX+FEKGEEEIIO/gqhBCChBAhhBDyP1aE0A9DCEKEEEKkEMJEiP5NCM2TUIQQqoS+b8I8CEEIdQn9N+F5IQQhtCW0bhuE0H8hhCB0CU3D8I4QhC7B9+UhhC6FaUIoTRBC6ED4g+A3QgghdOENJIT6NwhBuCF+EELvQmhDtA6aELoTWhOEc0LoIghBCH0LzRAaLwSBkBBChBCChBC6EKqEEELrRAjNCaENQTehH4TGE4QQ+lG4Bf1iA6GEEHpHCKE9IdQhdCdUCCE0ZwhdaDwhdBe0TQj9IBQhhBC6EKoTQm1CuAl9ILwEIdQndC8mEEIIpQmhJkL3YhdC/1+BEEI3Qm1CeCGEEEIIofcMhNCb0A+hG0JnQmk6aEIIIYReL0I/hDaE2oReEMpGCCA0TQjVCH0f6kJ4hRBC6AWhG4TGEyGEEMITQoh+IYSwhhBCEELvWwh9CM0QRQjVCOEN4ReFEILQnaAThDaEegidCSGEEGoThNC88B6E0AQhBCGEGkJoTohGhNCGkJkQ+iHEaRBCv8bK0P+9CEEIMYQQQohQQghBCH3/4J8IoQuhH0LrhNAsEKGEEELrE0JoQ/gjhC6FNoReEJoQ+kEIIYReEELoTaggdCe0RgghhDaE7oTwhRBC6EIIIfQnhNCG0BWhYUKoQwhB6EKIGkJrQmhDtA6EEEJnQj9Ebwj9EIQQQmhC6ET4x34BfLwQeucn9L+JEEKIGkIIIYQQQk2EEMITwvc/CCHk4EEIIYRehRBC6EH4d3whhLCE/jfw6EEIIYQQwveL/QQIoQkhQghBuCFCCCEIIYQQQgiBWBBCEIIQPnwhhJATQk2EEELrRAghhNCb0JoQmhBCEMIIpQmhCYFGEEIIQeghhLCEEGIIQQhdCP+fA0JrhRBCCH0Q/l8LhBCaEIIIIdQhdCM0Rwh9CF0JpQmBH0IIIfSjUIII/RehCaEThRBCaED4/x4IoQkhQgi1CaEToR/Ck4MQghBCaEJ4Twh9EMIQohOEEEIIQeha4D/WEIIIIdQhNCE0QwiNEULoTPhPGEIIofVCCCE0QxAhdCG0RgghhNAtEIII/QmhCaE74XlCCEEKIdQgNB+EEEJvhNCG0IXwdwgCofWCEEII3QnhF4TGE4RGEEI3QgghVCN8DUIoTRBCaEIQ2oEQQohQjRBCaIboRCghdCM8ryGEEEIpoUmhCaFNoQnB/RBC6EH4o1BCaEIIIbQmNCE0TQj9EIIQWhNCGUL7hRBCaEIIoRWhjRBCX4ReEIQQmtA/IYTGE0JnQm1CCEGIIAThhNCG0BoRQsOAECGE0AQhBKEToV+hDSEToXWhfSEMIUSNEEIIrReaEHpBCKE7oR8aBCH0o7+EECGEEIQQohGEEEIIpQkCEEIITQihCaEVQm1CaEDoG5/vX/30V5qgAAAAAElFTkSuQmCC";
        let isSpecialCatVisible = false; // íŠ¹ë³„í•œ ê³ ì–‘ì´ê°€ ë³´ì´ëŠ” ì¤‘ì¸ì§€ ì¶”ì í•˜ëŠ” ë³€ìˆ˜

        // [ì¶”ê°€] íƒ€ì´í•‘ ì‹œ 0.1% í™•ë¥ ë¡œ ê³ ì–‘ì´ ëª¨ìŠµ ë°”ê¾¸ê¸°
        messageInput.addEventListener('input', () => {
            // 0.1% í™•ë¥ (0.001)ì´ê³ , íŠ¹ë³„í•œ ê³ ì–‘ì´ê°€ ì•„ì§ ì•ˆë³´ì¼ ë•Œ
            if (Math.random() < 0.001 && !isSpecialCatVisible) {
                isSpecialCatVisible = true;
                
                // íŠ¹ë³„í•œ ê³ ì–‘ì´ ì´ë¯¸ì§€ë¡œ ë³€ê²½
                catEmojiElement.innerHTML = `<img src="${specialCatImageUrl}" alt="special cat" class="w-12 h-12">`;

                // 5ì´ˆ í›„ì— ë‹¤ì‹œ ì›ë˜ ì´ëª¨ì§€ë¡œ ë˜ëŒë¦¼
                setTimeout(() => {
                    catEmojiElement.innerHTML = 'ğŸˆ';
                    isSpecialCatVisible = false;
                }, 5000); // 5ì´ˆ
            }
        });

        const catNameElement = document.getElementById('cat-name');
        const names = ["ì´*í˜", "ê³ *ê±´", "ì†¡*í›ˆ", "ìµœ*ì¤€", "í•œ*ìƒ", "ë°•*ì›", "ì´*ìˆ˜", "ì´*ì˜", "íŠ¸ë¼ë¼ë¼ë¼ë¼ë¼"];
        const randomName = names[Math.floor(Math.random() * names.length)];
        catNameElement.textContent = randomName;
        
    </script>
</body>
</html>