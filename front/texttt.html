<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ì±„íŒ…</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; }
        #chat-messages::-webkit-scrollbar { width: 8px; }
        #chat-messages::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #chat-messages::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        #chat-messages::-webkit-scrollbar-thumb:hover { background: #555; }
        #rolling-cat-container {
            position: fixed;
            bottom: 10px;
            left: 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            animation: rollAcross 20s linear infinite;
        }
        #cat-emoji { 
            font-size: 40px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #cat-name {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-bottom: 5px;
            white-space: nowrap;
        }
        @keyframes rollAcross {
            0% { transform: translateX(-100px) rotate(0deg); }
            100% { transform: translateX(100vw) rotate(1800deg); }
        }
    </style>
</head>
<body class="bg-white flex items-center justify-center min-h-screen">
    <div class="w-full max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-gray-50 border border-gray-200 rounded-2xl shadow-lg p-6 flex flex-col h-[90vh] max-h-[900px]">

            <!-- ë¡œê·¸ì¸ í™”ë©´ -->
            <div id="login-screen" class="flex flex-col items-center justify-center h-full">
                <h1 class="text-3xl font-bold text-gray-900 mb-4">ë¡œê·¸ì¸</h1>
                <p class="text-gray-600 mb-8 text-center">ê³„ì •ì— ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>
                <div class="w-full max-w-sm flex flex-col items-center gap-4">
                    <input id="login-email-input" type="email" placeholder="ì´ë©”ì¼" class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg text-center" />
                    <input id="login-password-input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg text-center" />
                    <button id="login-btn" class="w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">ë¡œê·¸ì¸</button>
                    <div class="my-2 flex items-center w-full"><hr class="w-full border-gray-300"><span class="px-4 text-gray-500 text-sm">ë˜ëŠ”</span><hr class="w-full border-gray-300"></div>
                    <button id="guest-login-btn" class="w-full px-6 py-3 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600">ê²ŒìŠ¤íŠ¸ë¡œ ë¡œê·¸ì¸</button>
                    <p class="text-sm text-gray-600 mt-4">
                        ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <button id="go-to-signup-btn" class="font-semibold text-blue-600 hover:underline">íšŒì›ê°€ì…</button>
                    </p>
                </div>
            </div>

            <!-- íšŒì›ê°€ì… í™”ë©´ -->
            <div id="signup-screen" class="hidden flex-col items-center justify-center h-full">
                <h1 class="text-3xl font-bold text-gray-900 mb-4">íšŒì›ê°€ì…</h1>
                <p class="text-gray-600 mb-8 text-center">ìƒˆë¡œìš´ ê³„ì •ì„ ë§Œë“œì„¸ìš”.</p>
                <div class="w-full max-w-sm flex flex-col items-center gap-4">
                    <input id="signup-email-input" type="email" placeholder="ì´ë©”ì¼" class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg text-center" />
                    <input id="signup-password-input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg text-center" />
                    <button id="signup-btn" class="w-full px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700">íšŒì›ê°€ì…</button>
                     <p class="text-sm text-gray-600">
                        ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <button id="go-to-login-btn" class="font-semibold text-blue-600 hover:underline">ë¡œê·¸ì¸</button>
                    </p>
                </div>
            </div>


            <!-- ë°© ì„ íƒ í™”ë©´ -->
            <div id="room-selection" class="hidden flex-col items-center justify-center h-full">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">ì‹¤ì‹œê°„ ì±„íŒ…</h1>
                 <div id="user-info" class="text-center mb-6">
                    <p class="text-sm text-gray-600"><span id="user-email-display"></span>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!</p>
                    <div class="flex gap-4 justify-center">
                        <button id="logout-btn" class="text-xs text-red-500 hover:underline">ë¡œê·¸ì•„ì›ƒ</button>
                        <button id="user-management-btn" class="text-xs text-purple-600 hover:underline">ì‚¬ìš©ì ê´€ë¦¬</button>
                    </div>
                </div>
                <p class="text-gray-600 mb-8 text-center">ì¹œêµ¬ì™€ ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”.</p>
                <div class="w-full max-w-sm flex flex-col items-center gap-4">
                    <div class="w-full">
                        <label for="room-id-input" class="block text-sm font-medium text-gray-700 mb-2 text-center">ê¸°ì¡´ ë°© ì°¸ì—¬í•˜ê¸° (ID ì…ë ¥)</label>
                        <div class="flex gap-2">
                            <input id="room-id-input" type="text" placeholder="ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”" class="flex-1 p-3 bg-gray-100 border border-gray-300 rounded-lg text-center"/>
                            <button id="join-existing-room-btn" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">ì°¸ì—¬</button>
                        </div>
                    </div>
                    <div class="my-2 flex items-center w-full"><hr class="w-full border-gray-300"><span class="px-4 text-gray-500">ë˜ëŠ”</span><hr class="w-full border-gray-300"></div>
                    <button id="create-new-room-btn" class="hidden w-full px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700">ìƒˆë¡œìš´ ë°© ë§Œë“¤ê¸°</button>
                
                    <div class="my-4 w-full">
                        <h3 class="text-center text-sm font-medium text-gray-700 mb-2">ì°¸ì—¬ ê°€ëŠ¥í•œ ë°© ëª©ë¡</h3>
                        <div id="available-rooms-list" class="flex flex-col gap-2 max-h-40 overflow-y-auto p-2 bg-gray-100 rounded-lg">
                            <!-- Room buttons will be inserted here by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì‚¬ìš©ì ê´€ë¦¬ í™”ë©´ -->
            <div id="user-management-panel" class="hidden flex-col h-full">
                <div class="flex justify-between items-center w-full mb-4">
                    <h1 class="text-3xl font-bold text-gray-900">ì‚¬ìš©ì ê´€ë¦¬</h1>
                    <button id="back-to-rooms-btn" class="text-sm text-blue-600 hover:underline">ë°© ëª©ë¡ìœ¼ë¡œ</button>
                </div>
                <p class="text-gray-600 mb-6">ì‚¬ìš©ì ë‹‰ë„¤ì„ ë° ë¹„ë°€ë²ˆí˜¸ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
                <div id="user-list-management" class="flex-1 overflow-y-auto w-full bg-gray-100 p-4 rounded-lg">
                    <!-- User list will be rendered here -->
                </div>
            </div>

            <!-- ëŒ€í™” ì£¼ì œ ì„ íƒ í™”ë©´ -->
            <div id="topic-selection" class="hidden flex-col items-center justify-center h-full">
                <h1 class="text-2xl font-bold text-gray-900 mb-6">ë‹¹ì‹ ì€ ì‹œë¯¼ì…ë‹ˆë‹¤</h1>
                <div id="random-topic-display" class="mb-8 text-2xl text-center text-gray-700 bg-gray-100 px-8 py-4 rounded-lg">
                    <!-- JavaScriptì— ì˜í•´ ì£¼ì œê°€ ì±„ì›Œì§‘ë‹ˆë‹¤ -->
                </div>
                <button id="start-chat-btn" class="w-full max-w-xs px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">ì±„íŒ… ì‹œì‘í•˜ê¸°</button>
            </div>

            <!-- ì±„íŒ…ë°© í™”ë©´ -->
            <div id="chat-room" class="hidden flex-1 flex-col min-h-0">
                <div class="mb-4">
                     <div class="grid grid-cols-3 items-center mb-2">
                        <div class="text-left">
                           <h1 class="text-3xl font-bold text-gray-900">ì±„íŒ…ë°©</h1>
                        </div>
                        <div class="text-center col-span-1">
                           <p class="text-lg text-gray-600">ì§ì—… : ì‹œë¯¼</span></p>
                           <!-- ì„œë²„ì—ì„œ ì„ íƒí•œ ì œì‹œì–´(ë¹„ë°€ ë‹¨ì–´) í‘œì‹œ -->
                           <p class="text-sm text-gray-500 mt-1">ì œì‹œì–´: <span id="secret-word-display" class="font-semibold text-gray-700">-</span></p>
                        </div>
                        <div class="text-right">
                           <button id="leave-room-btn" class="text-sm text-red-500 hover:underline">ë‚˜ê°€ê¸°</button>
                        </div>
                     </div>
                    <p class="text-base text-gray-500 break-all">ë°© ID: <span id="room-id-display" class="font-mono"></span></p>
                    <p class="text-base text-gray-500 break-all">ë‚´ í”„ë¡œí•„: <span id="user-id-display" class="font-mono"></span></p>
                    <div id="participants-status" class="text-sm text-gray-500 mt-2 h-4"></div>
                </div>
                <div id="chat-messages" class="flex-1 overflow-y-auto bg-gray-100 p-4 rounded-lg mb-4 border border-gray-200"></div>
                <form id="message-form" class="flex items-center gap-3">
                    <input id="message-input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" class="flex-1 p-3 bg-white border border-gray-300 rounded-lg text-lg"/>
                    <button id="send-btn" type="submit" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">ì „ì†¡</button>
                </form>
            </div>
        </div>
    </div>
    
    <div id="rolling-cat-container">
        <div id="cat-name"></div>
        <div id="cat-emoji">ğŸˆ</div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, runTransaction, where, getDocs, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDMgGwmlV9T8l0CPsMrJ8H0NrTTUNtSDMo",
            authDomain: "text-861c1.firebaseapp.com",
            projectId: "text-861c1",
            storageBucket: "text-861c1.firebasestorage.app",
            messagingSenderId: "521608830043",
            appId: "1:521608830043:web:5df3d118d76ca4562eb37e",
        };
        
        const loginScreen = document.getElementById('login-screen');
        const signupScreen = document.getElementById('signup-screen');
        const loginEmailInput = document.getElementById('login-email-input');
        const loginPasswordInput = document.getElementById('login-password-input');
        const signupEmailInput = document.getElementById('signup-email-input');
        const signupPasswordInput = document.getElementById('signup-password-input');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const guestLoginBtn = document.getElementById('guest-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const goToSignupBtn = document.getElementById('go-to-signup-btn');
        const goToLoginBtn = document.getElementById('go-to-login-btn');
        const userEmailDisplay = document.getElementById('user-email-display');
        
        const roomSelection = document.getElementById('room-selection');
        const topicSelection = document.getElementById('topic-selection');
        const chatRoom = document.getElementById('chat-room');
        const userManagementPanel = document.getElementById('user-management-panel');
        const userManagementBtn = document.getElementById('user-management-btn');
        const backToRoomsBtn = document.getElementById('back-to-rooms-btn');
        const userListManagement = document.getElementById('user-list-management');

        const roomIdInput = document.getElementById('room-id-input');
        const joinExistingRoomBtn = document.getElementById('join-existing-room-btn');
        const createNewRoomBtn = document.getElementById('create-new-room-btn');
        const leaveRoomBtn = document.getElementById('leave-room-btn');
        const roomIdDisplay = document.getElementById('room-id-display');
        const userIdDisplay = document.getElementById('user-id-display');
        const chatMessages = document.getElementById('chat-messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const participantsStatus = document.getElementById('participants-status');
        const availableRoomsList = document.getElementById('available-rooms-list');
        const topicDisplay = document.getElementById('topic-display');
        const randomTopicDisplay = document.getElementById('random-topic-display');
        const startChatBtn = document.getElementById('start-chat-btn');
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const animals = [
            { emoji: 'ğŸ¶', name: 'ë©ë©ì´' },
            { emoji: 'ğŸ±', name: 'ì•¼ì˜¹ì´' },
            { emoji: 'ğŸ¦Š', name: 'ë¶ˆì—¬ìš°' },
            { emoji: 'ğŸ»', name: 'ê³°ëŒì´' },
            { emoji: 'ğŸ¼', name: 'íŒë‹¤' },
            { emoji: 'ğŸ¨', name: 'ì½”ì•Œë¼' }
        ];

        let currentUser = null, currentRoomId = null;
        let unsubscribeMessages = null, unsubscribeTurnStatus = null;
        let selectedTopic = null;
        let userAnimalProfile = null;
        let participantProfiles = {};
        let currentMessages = [];
        let roomListTimer = null;
        let isCurrentUserAdmin = false; // í˜„ì¬ ì‚¬ìš©ìê°€ ê´€ë¦¬ìì¸ì§€ ì—¬ë¶€
        let currentNameMapping = {};   // í˜„ì¬ ë°©ì˜ ì´ë¦„ ë§¤í•‘ ê°ì²´
        
        function showNotification(message, type = 'success', duration = 5000) {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            notification.className = `fixed top-5 right-5 ${bgColor} text-white py-2 px-4 rounded-lg shadow-lg z-50`;
            notification.innerHTML = message;
            document.body.appendChild(notification);
            setTimeout(() => { notification.remove(); }, duration);
        }

        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;
            // ë°°ì—´ì— ìš”ì†Œê°€ ë‚¨ì•„ìˆëŠ” ë™ì•ˆ
            while (currentIndex != 0) {
                // ë‚¨ì€ ìš”ì†Œ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒ
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                // í˜„ì¬ ìš”ì†Œì™€ êµí™˜
                [array[currentIndex], array[randomIndex]] = [
                    array[randomIndex], array[currentIndex]];
            }
            return array;
        }
        
        function listenToAvailableRooms() {
            if (roomListTimer) clearInterval(roomListTimer);

            const q = query(collection(db, 'chat_rooms'), where("isDeleted", "==", false));
            let currentRoomDocs = [];

            const renderRoomList = () => {
                availableRoomsList.innerHTML = '';
                const tenSecondsAgo = Date.now() - 10000;

                const roomsToRender = currentRoomDocs.filter(doc => {
                    const roomData = doc.data();
                    const participantCount = roomData.participantCount || 0;
                    if (participantCount > 0) {
                        return true;
                    }
                    if (roomData.emptySince) {
                        const emptyTime = roomData.emptySince.toMillis();
                        if (emptyTime > tenSecondsAgo) {
                            return true;
                        }
                    }
                    return false;
                });

                if (roomsToRender.length === 0) {
                    const noRoomsMessage = document.createElement('p');
                    noRoomsMessage.className = 'text-center text-gray-500 text-sm py-4';
                    noRoomsMessage.textContent = 'í˜„ì¬ ì°¸ì—¬ ê°€ëŠ¥í•œ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.';
                    availableRoomsList.appendChild(noRoomsMessage);
                    return;
                }

                roomsToRender.forEach(doc => {
                    const roomId = doc.id;
                    const roomContainer = document.createElement('div');
                    roomContainer.className = 'flex items-center gap-2 w-full';

                    const roomBtn = document.createElement('button');
                    roomBtn.className = 'flex-1 p-2 font-semibold rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 transition-colors';
                    roomBtn.textContent = `${roomId}`;
                    roomBtn.addEventListener('click', () => showTopicSelectionScreen(roomId));
                    
                    roomContainer.appendChild(roomBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'px-3 py-2 bg-red-500 text-white text-xs font-semibold rounded-lg hover:bg-red-600 transition-colors';
                    deleteBtn.textContent = 'ì‚­ì œ';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteRoom(roomId);
                    });
                    roomContainer.appendChild(deleteBtn);
                    
                    availableRoomsList.appendChild(roomContainer);
                });
            };

            onSnapshot(q, (snapshot) => {
                currentRoomDocs = snapshot.docs;
                renderRoomList();
            }, (error) => {
                console.error("Error listening to available rooms:", error);
                showNotification("ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
            });
            
            roomListTimer = setInterval(renderRoomList, 1000);
        }
        
        async function deleteRoom(roomId) {
            console.log(`User requesting deletion for room: ${roomId}`);
            try {
                if (!currentUser) {
                     showNotification("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.", "error");
                     return;
                }
                const adminRef = doc(db, "admins", currentUser.uid);
                const adminDoc = await getDoc(adminRef);
                if (!adminDoc.exists()) {
                    showNotification("ë°© ì‚­ì œëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.", "error");
                    return;
                }

                const roomRef = doc(db, 'chat_rooms', roomId);
                await updateDoc(roomRef, { isDeleted: true });
                showNotification(`'${roomId}' ë°©ì— ëŒ€í•œ ì‚­ì œë¥¼ ìš”ì²­í–ˆìŠµë‹ˆë‹¤.`, 'success');
            } catch (error) {
                console.error("Error requesting room deletion:", error);
                showNotification("ë°© ì‚­ì œ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                try {
                    const adminRef = doc(db, "admins", user.uid);
                    const adminDoc = await getDoc(adminRef);
                    const isUserAdmin = adminDoc.exists();
                    isCurrentUserAdmin = isUserAdmin;

                    if (isUserAdmin) {
                        createNewRoomBtn.classList.remove('hidden');
                        userManagementBtn.classList.remove('hidden');
                    } else {
                        createNewRoomBtn.classList.add('hidden');
                        userManagementBtn.classList.add('hidden');
                    }

                    const userRef = doc(db, 'users', user.uid);
                    const userDoc = await getDoc(userRef);

                    if (userDoc.exists()) {
                        userAnimalProfile = userDoc.data().animalProfile;
                    } else {
                        userAnimalProfile = animals[Math.floor(Math.random() * animals.length)];
                        await setDoc(userRef, {
                            email: user.email || 'guest',
                            animalProfile: userAnimalProfile,
                        });
                    }

                    userIdDisplay.textContent = `${userAnimalProfile.emoji} ${userAnimalProfile.name}`;
                    userEmailDisplay.textContent = user.isAnonymous ? "ê²ŒìŠ¤íŠ¸" : user.email;

                    loginScreen.classList.add('hidden');
                    signupScreen.classList.add('hidden');
                    roomSelection.classList.remove('hidden');
                    roomSelection.classList.add('flex');
                    userManagementPanel.classList.add('hidden');

                    listenToAvailableRooms();
                } catch (error) {
                    console.error("Error during authentication state change:", error);
                    showNotification(`ë¡œê·¸ì¸ ì¤‘ í”„ë¡œí•„/ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨: ${error.message}`, "error");
                    signOut(auth);
                }
            } else {
                currentUser = null;
                if (roomListTimer) clearInterval(roomListTimer);
                loginScreen.classList.remove('hidden');
                loginScreen.classList.add('flex');
                signupScreen.classList.add('hidden');
                roomSelection.classList.add('hidden');
                chatRoom.classList.add('hidden');
                topicSelection.classList.add('hidden');
                userManagementPanel.classList.add('hidden');
            }
        });
        
        const lockUI = () => {
            messageInput.disabled = true;
            sendBtn.disabled = true;
            sendBtn.textContent = 'ëŒ€ê¸° ì¤‘...';
        };
        const unlockUI = () => {
            messageInput.disabled = false;
            sendBtn.disabled = false;
            sendBtn.textContent = 'ì „ì†¡';
        };

        async function showTopicSelectionScreen(roomId) {
        currentRoomId = roomId;

        // ğŸ”½ *** 2-1. [ìˆ˜ì •] Firestoreê°€ ì•„ë‹Œ, "ê²Œì„ ì„¤ì • API"ë¥¼ í˜¸ì¶œ *** ğŸ”½
        try {
            // 1. [í•µì‹¬] ë°±ì—”ë“œì˜ "set_game_word" APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
            // (ì´ í˜¸ì¶œë¡œ ë°±ì—”ë“œì˜ ì „ì—­ ë³€ìˆ˜ current_wordì™€ current_categoryê°€ ì„¤ì •ë©ë‹ˆë‹¤)
            const resp = await fetch('http://localhost:5000/api/set_game_word', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json; charset=utf-8' }
            });
            
            if (!resp.ok) {
                throw new Error(`API Error: ${await resp.text()}`);
            }
            
            const data = await resp.json();
            
            // 2. ë°±ì—”ë“œê°€ ì •í•´ì¤€ "ì¹´í…Œê³ ë¦¬"ë¥¼ ë°›ì•„ì™€ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤.
            selectedTopic = data.category || 'ì•Œ ìˆ˜ ì—†ìŒ'; // ì „ì—­ ë³€ìˆ˜ì—ë„ ì €ì¥
            randomTopicDisplay.textContent = `ì¹´í…Œê³ ë¦¬: ${selectedTopic}`;
            
            // 3. (ì„ íƒì‚¬í•­) Firestore turn_statusì—ë„ ì¹´í…Œê³ ë¦¬ ê¸°ë¡
            try {
                const turnStatusRef = doc(db, `chat_rooms/${currentRoomId}/turn_status`, 'current');
                await setDoc(turnStatusRef, { topic: selectedTopic, word: null }, { merge: true });
            } catch (errSync) {
                console.warn('turn_statusì— ì¹´í…Œê³ ë¦¬ ê¸°ë¡ ì‹¤íŒ¨:', errSync);
            }

            // 4. ì¹´í…Œê³ ë¦¬ ì„ íƒ í™”ë©´ìœ¼ë¡œ ì „í™˜
            roomSelection.classList.add('hidden'); // (IDê°€ room-list-panelì¼ ìˆ˜ ìˆìŒ)
            userManagementPanel.classList.add('hidden');
            topicSelection.classList.remove('hidden');
            topicSelection.classList.add('flex');
            
        } catch(error) {
            console.error("Error in showTopicSelectionScreen:", error);
            showNotification(`ê²Œì„ ì„¤ì • API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, "error");
        }
        // ğŸ”¼ *** 2-1. ìˆ˜ì • ì™„ë£Œ *** ğŸ”¼
    }

        startChatBtn.addEventListener('click', () => {
            (async () => {
                if (!currentRoomId) return showNotification("ë°© IDê°€ ì—†ìŠµë‹ˆë‹¤.", "error");
                try {
                    const resp = await fetch('http://localhost:5000/api/start_dec', {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json; charset=utf-8' }
                    });
                    if (!resp.ok) throw new Error(await resp.text());
                    const data = await resp.json();
                    
                    currentWord = data.word || null;
                    const secretEl = document.getElementById('secret-word-display');
                    if (secretEl) secretEl.textContent = currentWord || '-';

                   // ===== ë™ê¸°í™”: ì„œë²„ê°€ ì •í•œ ì œì‹œì–´ë¥¼ ë°©ì˜ turn_statusì— ê¸°ë¡ =====
                   try {
                       const turnStatusRef = doc(db, `chat_rooms/${currentRoomId}/turn_status`, 'current');
                       await updateDoc(turnStatusRef, { word: currentWord });
                   } catch (errSync) {
                       console.warn('turn_statusì— ì œì‹œì–´ ê¸°ë¡ ì‹¤íŒ¨:', errSync);
                   }
                   // =======================================================

                    // ğŸ”½ *** ìˆ˜ì •ëœ ë¶€ë¶„ (1/2) *** ğŸ”½
                    // ì±„íŒ…ë°©ì— ë¨¼ì € ì…ì¥í•˜ì—¬ chatMessages ì—˜ë¦¬ë¨¼íŠ¸ê°€ ì¤€ë¹„ë˜ë„ë¡ í•©ë‹ˆë‹¤.
                    enterChatRoom(currentRoomId);
                    
                    // AIì˜ ì²« ë²ˆì§¸ ì§„ìˆ  ë©”ì‹œì§€ë¥¼ ì±„íŒ…ì°½ì— í‘œì‹œí•©ë‹ˆë‹¤.
                    if (data.declaration_messages && Array.isArray(data.declaration_messages)) {
                        // "ì§„ìˆ " ë¼ìš´ë“œë¼ëŠ” ê²ƒì„ ì•Œë¦¬ëŠ” ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì¶”ê°€
                        const wrapper = document.createElement('div');
                        wrapper.className = 'flex justify-center my-3';
                        const textDiv = document.createElement('div');
                        textDiv.className = 'text-xs text-gray-500 bg-gray-200 px-3 py-1 rounded-full';
                        textDiv.textContent = '=== 1ì°¨ ì§„ìˆ  ì‹œì‘ ===';
                        wrapper.appendChild(textDiv);
                        chatMessages.appendChild(wrapper); // chatMessagesê°€ ì´ì œ ì‚¬ìš© ê°€ëŠ¥
                        
                        data.declaration_messages.forEach((msg, index) => {
                            // AI í”„ë¡œí•„ì´ ì—†ìœ¼ë¯€ë¡œ 'ai_X' IDë¥¼ ì‚¬ìš©
                            const aiBubble = renderSingleBubble({ text: msg, senderId: `ai_${index}` });
                            chatMessages.appendChild(aiBubble);
                        });
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                    
                    // "ì§„ìˆ " ë‹¨ê³„ê°€ ì™„ë£Œë˜ì—ˆìœ¼ë¯€ë¡œ, ë‹¤ìŒ ë‹¨ê³„ë¥¼ "í† ë¡ "ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
                    currentPhase = "í† ë¡ "; 
                    // ğŸ”¼ *** ìˆ˜ì • ì™„ë£Œ (1/2) *** ğŸ”¼

                    // enterChatRoom(currentRoomId); // â¬…ï¸ ì´ ë¼ì¸ì„ ìœ„ë¡œ ì´ë™ì‹œì¼°ìŠµë‹ˆë‹¤.
                } catch (err) {
                    console.error('start_dec failed:', err);
                    showNotification('ì œì‹œì–´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            })();
        });

        async function enterChatRoom(roomId) {
            topicSelection.classList.add('hidden');
            chatRoom.classList.remove('hidden'); 
            chatRoom.classList.add('flex');
            roomIdDisplay.textContent = roomId; 
            
            const roomRef = doc(db, 'chat_rooms', roomId);
            const turnStatusRef = doc(db, `chat_rooms/${roomId}/turn_status`, 'current');
            const userRef = doc(db, 'users', currentUser.uid);

            try {
                const turnStatusSnap = await getDoc(turnStatusRef);
                if (!turnStatusSnap.exists()) {
                    throw new Error("ë°© ìƒíƒœ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }

                const turnData = turnStatusSnap.data();
                const currentProfilesInRoom = turnData.participantProfiles || {};
                const participants = turnData.participants || [];
                let finalUserAnimalProfile = userAnimalProfile;
                let profileChanged = false;

                const isProfileTakenByOther = Object.values(currentProfilesInRoom)
                    .some(profile => profile.name === userAnimalProfile.name);

                if (isProfileTakenByOther && !participants.includes(currentUser.uid)) {
                    profileChanged = true;
                    const usedAnimalNames = Object.values(currentProfilesInRoom).map(p => p.name);
                    const availableAnimals = animals.filter(a => !usedAnimalNames.includes(a.name));

                    if (availableAnimals.length > 0) {
                        finalUserAnimalProfile = availableAnimals[Math.floor(Math.random() * availableAnimals.length)];
                    } else {
                        finalUserAnimalProfile = animals[Math.floor(Math.random() * animals.length)];
                        showNotification("ëª¨ë“  í”„ë¡œí•„ì´ ì‚¬ìš© ì¤‘ì´ë¼, ì¤‘ë³µëœ í”„ë¡œí•„ì´ í• ë‹¹ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", "error");
                    }
                }

                await runTransaction(db, async (transaction) => {
                    const freshTurnDoc = await transaction.get(turnStatusRef);
                    if (!freshTurnDoc.exists()) throw new Error("ë°© ìƒíƒœ ì •ë³´ë¥¼ íŠ¸ëœì­ì…˜ ì¤‘ì— ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    
                    const freshParticipants = freshTurnDoc.data().participants || [];

                    if (!freshParticipants.includes(currentUser.uid)) {
                        const newParticipants = [...freshParticipants, currentUser.uid];
                        transaction.update(turnStatusRef, {
                            participants: newParticipants,
                            [`participantProfiles.${currentUser.uid}`]: finalUserAnimalProfile
                        });
                        transaction.update(roomRef, { 
                            participantCount: newParticipants.length,
                            emptySince: deleteField()
                        });
                    }
                    
                    if (profileChanged) {
                        transaction.update(userRef, { animalProfile: finalUserAnimalProfile });
                    }
                });
                
                if (profileChanged) {
                    userAnimalProfile = finalUserAnimalProfile;
                    userIdDisplay.textContent = `${userAnimalProfile.emoji} ${userAnimalProfile.name}`;
                    showNotification(`í”„ë¡œí•„ì´ ì¤‘ë³µë˜ì–´ '${userAnimalProfile.name}'(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                }

            } catch (error) {
                 console.error("Error entering room:", error);
                 showNotification("ë°© ì…ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", 'error');
                 chatRoom.classList.add('hidden');
                 roomSelection.classList.remove('hidden');
                 return;
            }
            
            listenToTurnStatus(roomId);
            loadMessages(roomId);

            const messagesColPath = `chat_rooms/${currentRoomId}/messages`;
            await addDoc(collection(db, messagesColPath), {
                text: `${userAnimalProfile.emoji} ${userAnimalProfile.name}ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤.`,
                senderId: 'system',
                timestamp: serverTimestamp()
            });
        }


        joinExistingRoomBtn.addEventListener('click', async () => {
            const roomId = roomIdInput.value.trim(); 
            if (!roomId) return showNotification("ë°© IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", 'error');
            try {
                const docSnap = await getDoc(doc(db, 'chat_rooms', roomId));
                if (docSnap.exists() && docSnap.data().isDeleted === false) {
                    await showTopicSelectionScreen(roomId);
                } else { 
                    showNotification("ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì‚­ì œëœ ë°©ì…ë‹ˆë‹¤.", 'error');
                }
            } catch(error) {
                 console.error("Error joining room by ID:", error);
                showNotification("ë°© ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", 'error');
            }
        });

        createNewRoomBtn.addEventListener('click', async () => {
            const newRoomId = Math.random().toString(36).substring(2, 8);
            
                

            await setDoc(doc(db, 'chat_rooms', newRoomId), { 
                createdAt: serverTimestamp(),
                isDeleted: false,
                participantCount: 0
            });
            
            await setDoc(doc(db, `chat_rooms/${newRoomId}/turn_status`, 'current'), {
                topic: selectedTopic,
                participants: [],
                submissions: {},
                participantProfiles: {}
            });
            await showTopicSelectionScreen(newRoomId);
        });
        
        leaveRoomBtn.addEventListener('click', async () => {
            if (!currentRoomId || !currentUser) return;

            await addDoc(collection(db, `chat_rooms/${currentRoomId}/messages`), {
                text: `${userAnimalProfile.emoji} ${userAnimalProfile.name}ë‹˜ì´ í‡´ì¥í–ˆìŠµë‹ˆë‹¤.`,
                senderId: 'system',
                timestamp: serverTimestamp()
            });

            const roomRef = doc(db, 'chat_rooms', currentRoomId);
            const turnStatusRef = doc(db, `chat_rooms/${currentRoomId}/turn_status`, 'current');
            
            try {
                await runTransaction(db, async (transaction) => {
                    const turnDoc = await transaction.get(turnStatusRef);
                    if (!turnDoc.exists()) return;

                    const turnData = turnDoc.data();
                    const participants = turnData.participants || [];
                    
                    const newParticipants = participants.filter(uid => uid !== currentUser.uid);
                    transaction.update(turnStatusRef, { participants: newParticipants });

                    if (newParticipants.length === 0) {
                        transaction.update(roomRef, {
                            participantCount: 0,
                            emptySince: serverTimestamp()
                        });
                    } else {
                        transaction.update(roomRef, {
                            participantCount: newParticipants.length
                        });
                    }
                });
            } catch (error) {
                console.error("Failed to leave room:", error);
                showNotification("ë°©ì„ ë‚˜ê°€ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", 'error');
            }

            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribeTurnStatus) unsubscribeTurnStatus();

            currentRoomId = null; 
            chatMessages.innerHTML = ''; 
            currentMessages = []; 
            participantsStatus.textContent = '';
            chatRoom.classList.add('hidden'); 
            topicSelection.classList.add('hidden');
            roomSelection.classList.remove('hidden');
            listenToAvailableRooms();
            unlockUI();
        });

        function loadMessages(roomId) {
            const q = query(collection(db, `chat_rooms/${roomId}/messages`));
            unsubscribeMessages = onSnapshot(q, snapshot => {
                let messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                messages.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                currentMessages = messages; 
                renderMessages(messages); 
            });
        }
        
        function listenToTurnStatus(roomId) {
            const turnStatusRef = doc(db, `chat_rooms/${roomId}/turn_status`, 'current');
            unsubscribeTurnStatus = onSnapshot(turnStatusRef, (docSnap) => {
                if (!docSnap.exists()) return;
                
                const turnData = docSnap.data();
                const submissions = turnData.submissions || {};
                const participants = turnData.participants || [];
                const newParticipantProfiles = turnData.participantProfiles || {};
                selectedTopic = turnData.topic; 

                // ì„œë²„/ìš´ì˜ìê°€ ì„¤ì •í•œ ì œì‹œì–´ê°€ ìˆìœ¼ë©´ í™”ë©´ì— í‘œì‹œ
                const secretEl = document.getElementById('secret-word-display');
                if (secretEl) {
                    secretEl.textContent = turnData.word || '-';
                    // í”„ë¡ íŠ¸ ë³€ìˆ˜ë„ ë™ê¸°í™”
                    currentWord = turnData.word || currentWord;
                }

                if (JSON.stringify(participantProfiles) !== JSON.stringify(newParticipantProfiles)) {
                    participantProfiles = newParticipantProfiles;
                    if (currentMessages.length > 0) {
                        renderMessages(currentMessages);
                    }
                }

                topicDisplay.innerHTML = `<span class="font-semibold text-gray-700">${selectedTopic}</span>`;
                
                participantsStatus.textContent = `ì°¸ê°€ì: ${participants.length}ëª… | ì œì¶œ í˜„í™©: ${Object.keys(submissions).length} / ${participants.length}`;

                if (submissions[currentUser.uid]) {
                    lockUI();
                } else {
                    unlockUI();
                }
            });
        }
        
        function renderSingleBubble(msgData, isRound = false) {
             const isMe = msgData.senderId === currentUser.uid;
             const wrapper = document.createElement('div');
             wrapper.className = `flex ${isMe ? 'justify-end' : 'justify-start'} ${isRound ? 'my-1' : 'mb-3'}`;
             
             const container = document.createElement('div');
             
             const senderProfile = participantProfiles[msgData.senderId] || (isMe ? userAnimalProfile : { emoji: 'ğŸ‘¤', name: 'ìµëª…' });
    
             const senderName = document.createElement('p');
             senderName.className = `text-xs text-gray-500 mb-1 ${isMe ? 'text-right mr-3' : 'ml-3'}`;
             senderName.textContent = `${senderProfile.emoji} ${senderProfile.name}`;
             container.appendChild(senderName);

             const bubble = document.createElement('div');
             let bubbleClasses = 'max-w-md lg:max-w-lg px-4 py-3 rounded-2xl text-lg ';
             bubble.className = bubbleClasses + (isMe ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800');
             bubble.textContent = msgData.text;
             
             container.appendChild(bubble);
             wrapper.appendChild(container);
             return wrapper;
        }

        function renderMessages(messages) {
            chatMessages.innerHTML = ''; 
            messages.forEach(msg => {
                if (msg.senderId === 'system') {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'flex justify-center my-3';
                    const textDiv = document.createElement('div');
                    textDiv.className = 'text-xs text-gray-500 bg-gray-200 px-3 py-1 rounded-full';
                    textDiv.textContent = msg.text;
                    wrapper.appendChild(textDiv);
                    chatMessages.appendChild(wrapper);
                } else if (msg.type === 'round' && msg.roundData) {
                    const roundWrapper = document.createElement('div');
                    roundWrapper.className = 'border-l-2 border-gray-300 pl-3 my-4 py-2';
                    msg.roundData.forEach(roundMsg => {
                        roundWrapper.appendChild(renderSingleBubble(roundMsg, true));
                    });
                    chatMessages.appendChild(roundWrapper);
                } else {
                     chatMessages.appendChild(renderSingleBubble(msg));
                }
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // ë°±ì—”ë“œì˜ AI ì‘ë‹µ ìƒì„± ì—”ë“œí¬ì¸íŠ¸ë¥¼ í˜¸ì¶œí•˜ëŠ” í•¨ìˆ˜
        // ë¼ìš´ë“œ ìƒíƒœ ì¶”ì ìš© (ì´ˆê¸°ê°’ì€ ì§„ìˆ )
        let currentPhase = "ì§„ìˆ ";
        let currentWord = null;

        // ë°±ì—”ë“œì˜ AI ì‘ë‹µ ìƒì„± ì—”ë“œí¬ì¸íŠ¸ë¥¼ í˜¸ì¶œí•˜ëŠ” í•¨ìˆ˜
        async function sendMessageToAI(userMessage) {
            try {
                // ğŸ”½ *** ìˆ˜ì •ëœ ë¶€ë¶„ *** ğŸ”½
                // ëª¨ë“  AI ì‘ë‹µ ìš”ì²­ì„ /api/ai_response ì—”ë“œí¬ì¸íŠ¸ë¡œ í†µì¼í•©ë‹ˆë‹¤.
                // /api/start_decëŠ” startChatBtnì—ì„œë§Œ í˜¸ì¶œí•˜ë„ë¡ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.
                // currentWordëŠ” ë°±ì—”ë“œ ì„œë²„ì— ì €ì¥ëœ ê°’ì„ ì‚¬ìš©í•˜ë¯€ë¡œ ë³´ë‚¼ í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.

                const endpoint = "http://localhost:5000/api/ai_response";
                const bodyData = { 
                    prompt: userMessage,  // ì‚¬ìš©ìì˜ ì±„íŒ… ë©”ì‹œì§€
                    phase: currentPhase   // í˜„ì¬ ê²Œì„ ë‹¨ê³„ (ì˜ˆ: "í† ë¡ ")
                };
                
                // ğŸ”¼ *** (ì´ì „ if/else ë¡œì§ ì‚­ì œ) *** ğŸ”¼

                const response = await fetch(endpoint, {
                    method: "PATCH",
                    headers: {
                        "Content-Type": "application/json; charset=utf-8"
                    },
                    body: JSON.stringify(bodyData)
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${await response.text()}`);
                }

                const data = await response.json();

                // ğŸ”½ *** ìˆ˜ì •ëœ ë¶€ë¶„ *** ğŸ”½
                // /api/ai_responseëŠ” í•­ìƒ "ai_response" í‚¤ë¡œ ì‘ë‹µí•©ë‹ˆë‹¤.
                
                if (data.word) {
                    // (ì°¸ê³ ) ì‘ë‹µì— wordê°€ í¬í•¨ë˜ì–´ ì˜¤ì§€ë§Œ, 
                    // ì´ë¯¸ startChatBtnì—ì„œ ì„¤ì •í–ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œ ê°±ì‹ í•  í•„ìš”ëŠ” ì—†ìŠµë‹ˆë‹¤.
                    currentWord = data.word; 
                }

                let aiResponse = null;

                if (data.ai_response) {
                    aiResponse = data.ai_response;
                } else {
                    // ì˜ˆì™¸ ì²˜ë¦¬: í˜¹ì‹œ ëª¨ë¥¼ ë‹¤ë¥¸ í˜•ì‹ì˜ ì‘ë‹µ
                    console.warn("AI ì‘ë‹µì´ 'ai_response' í‚¤ì— ì—†ìŠµë‹ˆë‹¤.", data);
                    return null;
                }
                
                // ğŸ”¼ *** (ì´ì „ declaration_messages ë“± ì²˜ë¦¬ ë¡œì§ ì‚­ì œ) *** ğŸ”¼

                return aiResponse;
            } catch (error) {
                console.error("Failed to fetch AI response:", error);
                return null;
            }
        }


        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userMessage = messageInput.value.trim();
            if (!userMessage) return;
            
            // ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ì±„íŒ…ì°½ì— ì¶”ê°€
            const userBubble = renderSingleBubble({ text: userMessage, senderId: currentUser.uid });
            chatMessages.appendChild(userBubble);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            messageInput.value = ''; // ì…ë ¥ì°½ ë¹„ìš°ê¸°

            // 2. ë°±ì—”ë“œ AIì—ê²Œ ì‘ë‹µ ìš”ì²­
            const aiResponse = await sendMessageToAI(userMessage);

            // 3. (AI) ì‘ë‹µì„ Firestoreì— "ì €ì¥"ë§Œ í•©ë‹ˆë‹¤. (ë Œë”ë§ X)
            // ğŸ”½ *** [ìˆ˜ì •] ì´ ë¸”ë¡ ì „ì²´ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤ *** ğŸ”½
            if (aiResponse && Array.isArray(aiResponse)) {
                
                // (ì´ì „ ì½”ë“œ: aiResponse.forEach(msg, index) => { ...)
                
                // 4. (AI) ì‘ë‹µì„ í™”ë©´ì— *ìˆ˜ë™ìœ¼ë¡œ* ë Œë”ë§ â¬…ï¸ [ì‚­ì œ]
                // const aiBubble = renderBubble(senderId, [{ text: msg }], false);
                // chatMessages.appendChild(aiBubble); â¬…ï¸ [ì‚­ì œ] ì´ ì¤„ì„ ì‚­ì œí•©ë‹ˆë‹¤.

                // 5. (AI) ì‘ë‹µ 4ê°œë¥¼ ê°ê° Firestoreì— "ì €ì¥"ë§Œ í•©ë‹ˆë‹¤.
                // ë Œë”ë§ì€ onSnapshotì´ ì•Œì•„ì„œ í•  ê²ƒì…ë‹ˆë‹¤.
                try {
                    aiResponse.forEach((msg, index) => {
                        const senderId = `ai_${index}`;
                        addDoc(messagesRef, {
                            text: msg,
                            senderId: senderId,
                            createdAt: serverTimestamp()
                        });
                    });
                } catch (err) {
                    console.error("Firestoreì— AI ì‘ë‹µ ì €ì¥ ì‹¤íŒ¨:", err);
                }
                
                // [ì°¸ê³ ] ìŠ¤í¬ë¡¤ ë¡œì§ì€ onSnapshot ì•ˆìœ¼ë¡œ ì´ë™í–ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œ í•„ìš” ì—†ìŠµë‹ˆë‹¤.
                // chatMessages.scrollTop = chatMessages.scrollHeight; â¬…ï¸ [ì‚­ì œ]

            } else {
                showNotification("AI ì‘ë‹µì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
            }
            // ğŸ”¼ *** [ìˆ˜ì •] ì™„ë£Œ *** ğŸ”¼
        });
        
        signupBtn.addEventListener('click', async () => {
            const email = signupEmailInput.value;
            const password = signupPasswordInput.value;
            if (!email || !password) {
                return showNotification("ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
            }
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showNotification("íšŒì›ê°€ì… ì„±ê³µ! ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ë©ë‹ˆë‹¤.", "success");
            } catch (error) {
                showNotification(`íšŒì›ê°€ì… ì‹¤íŒ¨: ${error.message}`, "error");
            }
        });

        loginBtn.addEventListener('click', async () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
             if (!email || !password) {
                return showNotification("ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
                 showNotification("ë¡œê·¸ì¸ ì„±ê³µ!", "success");
            } catch (error) {
                 showNotification(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`, "error");
            }
        });
        
        guestLoginBtn.addEventListener('click', async () => {
            try {
                await signInAnonymously(auth);
                showNotification("ê²ŒìŠ¤íŠ¸ë¡œ ë¡œê·¸ì¸ ì„±ê³µ!", "success");
            } catch (error) {
                showNotification(`ê²ŒìŠ¤íŠ¸ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`, "error");
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showNotification("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
            } catch (error) {
                 showNotification(`ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ${error.message}`, "error");
            }
        });

        goToSignupBtn.addEventListener('click', () => {
            loginScreen.classList.add('hidden');
            loginScreen.classList.remove('flex');
            signupScreen.classList.remove('hidden');
            signupScreen.classList.add('flex');
        });

        goToLoginBtn.addEventListener('click', () => {
            signupScreen.classList.add('hidden');
            signupScreen.classList.remove('flex');
            loginScreen.classList.remove('hidden');
            loginScreen.classList.add('flex');
        });

        userManagementBtn.addEventListener('click', () => {
            roomSelection.classList.add('hidden');
            userManagementPanel.classList.remove('hidden');
            userManagementPanel.classList.add('flex');
            loadAndRenderUsers();
        });

        backToRoomsBtn.addEventListener('click', () => {
            userManagementPanel.classList.add('hidden');
            roomSelection.classList.remove('hidden');
            roomSelection.classList.add('flex');
        });

        async function loadAndRenderUsers() {
            userListManagement.innerHTML = '<p>ì‚¬ìš©ì ëª©ë¡ ë¡œë”©ì¤‘...</p>';
            try {
                const usersCol = collection(db, 'users');
                const userSnapshot = await getDocs(usersCol);
                
                userListManagement.innerHTML = '';

                if (userSnapshot.empty) {
                     userListManagement.innerHTML = '<p>ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                     return;
                }

                userSnapshot.forEach(userDoc => {
                    const userData = userDoc.data();
                    const userId = userDoc.id;

                    const userDiv = document.createElement('div');
                    userDiv.className = 'p-3 mb-2 bg-white rounded-lg shadow-sm flex items-center justify-between';

                    const userInfoDiv = document.createElement('div');
                    const userEmailText = (userData.email === 'guest' || !userData.email) ? 'ê²ŒìŠ¤íŠ¸ ê³„ì •' : userData.email;
                    userInfoDiv.innerHTML = `
                        <p class="text-sm font-semibold">${userEmailText}</p>
                        <p class="text-xs text-gray-600">í˜„ì¬ ë‹‰ë„¤ì„: ${userData.animalProfile.emoji} ${userData.animalProfile.name}</p>
                    `;

                    const userActionDiv = document.createElement('div');
                    userActionDiv.className = 'flex items-center gap-2';

                    const newNameSelect = document.createElement('select');
                    newNameSelect.className = 'p-1 border rounded text-sm';
                    animals.forEach(animal => {
                        const option = document.createElement('option');
                        option.value = animal.name;
                        option.textContent = `${animal.emoji} ${animal.name}`;
                        if (animal.name === userData.animalProfile.name) {
                            option.selected = true;
                        }
                        newNameSelect.appendChild(option);
                    });

                    const saveBtn = document.createElement('button');
                    saveBtn.textContent = 'ì €ì¥';
                    saveBtn.className = 'px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600';
                    saveBtn.onclick = async () => {
                        const newName = newNameSelect.value;
                        const newProfile = animals.find(a => a.name === newName);
                        if (newProfile) {
                            await updateUserNickname(userId, newProfile);
                            loadAndRenderUsers(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        }
                    };
                    
                    userActionDiv.appendChild(newNameSelect);
                    userActionDiv.appendChild(saveBtn);

                    if (userData.email && userData.email !== 'guest') {
                        const resetPasswordBtn = document.createElement('button');
                        resetPasswordBtn.textContent = 'ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •';
                        resetPasswordBtn.className = 'px-2 py-1 bg-orange-500 text-white text-xs rounded hover:bg-orange-600';
                        resetPasswordBtn.onclick = () => {
                            sendPasswordReset(userData.email);
                        };
                        userActionDiv.appendChild(resetPasswordBtn);
                    }
                    
                    userDiv.appendChild(userInfoDiv);
                    userDiv.appendChild(userActionDiv);

                    userListManagement.appendChild(userDiv);
                });
            } catch(error) {
                console.error("Error loading users:", error);
                userListManagement.innerHTML = '<p class="text-red-500">ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
                showNotification("ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
            }
        }

        async function updateUserNickname(userId, newProfile) {
            try {
                const userRef = doc(db, 'users', userId);
                await updateDoc(userRef, { animalProfile: newProfile });
                showNotification("ë‹‰ë„¤ì„ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
            } catch (error) {
                console.error("Error updating nickname:", error);
                showNotification("ë‹‰ë„¤ì„ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
            }
        }
        
        async function sendPasswordReset(email) {
            try {
                await sendPasswordResetEmail(auth, email);
                showNotification(`${email}ìœ¼ë¡œ ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ë©”ì¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.`, "success");
            } catch (error) {
                console.error("Error sending password reset email:", error);
                showNotification("ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ë©”ì¼ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
            }
        }


        const catEmojiElement = document.getElementById('cat-emoji');
        const specialCatImageUrl = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAEnQAABJ0Ad5mH3gAAAUoSURBVHhe7VtdiFVVFL7v2+lu1VOzBjPMMsPSChIiiCBEsiiyoKIvCl0oF6GuhUIXgghZFgU9iIgiA9EDpdFFL0UXQW9EEARdKEPYDBKkZ5Znpudk+5x7Du/M2b1r7z1z9jrnwz8+955zfp9zZ87ce885gP+nEaE0IZQmBNmE0L1YhNCkI5QmBNmE0IZQm3BCaEKoTQhNCK3b9GkQghC+ZgihS0M0J9S2QmiD0DQhNCeEMgStEELrhNCG0Lq2CeH5IQQhNCeE2oRQE6E/QmhC+LgQmvB/DkL//xGhtCEAixAaFrRACG0IgRCaFkIQ+hAaF95fEIIQEIIQIX+FEKGEEEIIO/gqhBCChBAhhBDyP1aE0A/DCEKEEEKkEMJEiP5NCM2TUIQQqoS+b8I8CEEIdQn9N+F5IQQhtCW0bhuE0H8hhCB0CU3D8I4QhC7B9+UhhC6FaUIoTRBC6ED4g+A3QgghdOENJIT6NwhBuCF+EELvQmhDtA6aELoTWhOEc0LoIghBCH0LzRAaLwSBkBBChBCChBC6EKqEEELrRAjNCaENQTehH4TGE4QQ+lG4Bf1iA6GEEHpHCKE9IdQhdCdUCCE0ZwhdaDwhdBe0TQj9IBQhhBC6EKoTQm1CuAl9ILwEIdQndC8mEEIIpQmhJkL3YhdC/1+BEEI3Qm1CeCGEEEIIofcMhNCb0A+hGTOCAgAASURBVG0JnQmk6aEIIIYReL0I/hDaE2oReEMpGCCA0TQjVCH0f6kJ4hRBC6AWhG4TGEyGEEMITQoh+IYSwhhBCEELvWwh9CM0QRQjVCOEN4ReFEILQnaAThDaEegidCSGEEGoThNC88B6E0AQhBCGEGkJoTohGhNCGkJkQ+iHEaRBCv8bK0P+9CEEIMYQQQohQQghBCH3/4J8IoQuhH0LrhNAsEKGEEELrE0JoQ/gjhC6FNoReEJoQ+kEIIYReEELoTaggdCe0RgghhDaE7oTwhRBC6EIIIfQnhNCG0BWhYUKoQwhB6EKIGkJrQmhDtA6EEEJnQj9Ebwj9EIQQQmhC6ET4x34BfLwQeucn9L+JEEKIGkIIIYQQQk2EEMITwvc/CCHk4EEIIYRehRBC6EH4d3whhLCE/jfw6EEIIYQQwveL/QQIoQkhQghBuCFCCCEIIYQQQgiBWBBCEIIQPnwhhJATQk2EEELrRAghhNCb0JoQmhBCEMIIpQmhCYFGEEIIQeghhLCEEGIIQQhdCP+fA0JrhRBCCH0Q/l8LhBCaEIIIIdQhdCM0Rwh9CF0JpQmBH0IIIfSjUIII/RehCaEThRBCaEDoG5/vX/0V5qgAAAAAElFTuQmCC";
        let isSpecialCatVisible = false;

        messageInput.addEventListener('input', () => {
            if (Math.random() < 0.001 && !isSpecialCatVisible) {
                isSpecialCatVisible = true;
                catEmojiElement.innerHTML = `<img src="${specialCatImageUrl}" alt="special cat" class="w-12 h-12">`;
                setTimeout(() => {
                    catEmojiElement.innerHTML = 'ğŸˆ';
                    isSpecialCatVisible = false;
                }, 5000);
            }
        });

        const catNameElement = document.getElementById('cat-name');
        const names = ["ì´*í˜", "ê³ *ê±´", "ì†¡*í›ˆ", "ìµœ*ì¤€", "í•œ*ìƒ", "ë°•*ì›", "ì´*ìˆ˜", "ì´*ì˜", "íŠ¸ë¼ë¼ë¼ë¼ë¼ë¼"];
        const randomName = names[Math.floor(Math.random() * names.length)];
        catNameElement.textContent = randomName;
        
    </script>
</body>
</html>

